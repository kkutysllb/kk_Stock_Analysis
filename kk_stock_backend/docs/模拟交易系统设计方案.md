# KK量化分析系统 - 模拟交易系统设计方案

## 项目概述

基于现有的股票池、选股策略和量化回测功能，构建完整的模拟交易系统，为用户提供真实的模拟炒股体验。通过模拟交易验证策略效果，提升用户的投资决策能力。

## 1. 系统架构设计

### 1.1 核心模块
- **模拟账户管理模块** - 用户虚拟资金账户管理
- **持仓管理模块** - 股票持仓信息管理
- **交易执行引擎** - 买卖交易逻辑处理
- **策略集成层** - 与选股策略和量化系统对接
- **数据计算引擎** - 实时计算各类财务指标
- **风控系统** - 交易风险控制和合规检查

### 1.2 技术栈
- **后端**: FastAPI + MongoDB + Python
- **前端**: Vue 3 + TypeScript + Element Plus
- **数据源**: 现有的股票数据API
- **任务调度**: APScheduler (用于定时更新股价)

## 2. 数据库设计

### 2.1 模拟账户表 (simulation_accounts)
```python
{
    "_id": ObjectId,
    "user_id": str,                    # 用户ID
    "account_name": str,               # 账户名称，默认"模拟账户"
    "initial_capital": float,          # 初始资金：3,000,000
    "available_cash": float,           # 可用现金
    "frozen_cash": float,              # 冻结资金（挂单占用）
    "total_assets": float,             # 总资产
    "total_market_value": float,       # 持仓总市值
    "daily_return": float,             # 日收益金额
    "daily_return_rate": float,        # 日收益率
    "total_return": float,             # 总收益金额
    "total_return_rate": float,        # 总收益率
    "max_drawdown": float,             # 最大回撤
    "win_rate": float,                 # 胜率
    "trade_count": int,                # 交易次数
    "profit_trades": int,              # 盈利交易次数
    "loss_trades": int,                # 亏损交易次数
    "create_time": datetime,           # 创建时间
    "last_update_time": datetime,      # 最后更新时间
    "status": int                      # 状态：1-正常，0-冻结
}
```

### 2.2 持仓表 (simulation_positions)
```python
{
    "_id": ObjectId,
    "user_id": str,                    # 用户ID
    "stock_code": str,                 # 股票代码
    "stock_name": str,                 # 股票名称
    "market": str,                     # 市场：SH-上海，SZ-深圳
    "board_type": str,                 # 板块类型：MAIN-主板，GEM-创业板，STAR-科创板
    "total_quantity": int,             # 总持股数量（股）
    "available_quantity": int,         # 可卖数量（T+1限制）
    "frozen_quantity": int,            # 冻结数量（挂单占用）
    "avg_cost": float,                 # 平均成本价
    "current_price": float,            # 当前价格
    "market_value": float,             # 当前市值
    "cost_value": float,               # 成本市值
    "unrealized_pnl": float,           # 未实现盈亏
    "unrealized_pnl_rate": float,      # 未实现盈亏率
    "last_price_update": datetime,     # 最后价格更新时间
    "position_date": date,             # 建仓日期
    "update_time": datetime            # 更新时间
}
```

### 2.3 交易记录表 (simulation_trades)
```python
{
    "_id": ObjectId,
    "user_id": str,                    # 用户ID
    "trade_id": str,                   # 交易ID（唯一）
    "stock_code": str,                 # 股票代码
    "stock_name": str,                 # 股票名称
    "trade_type": str,                 # 交易类型：BUY-买入，SELL-卖出
    "order_type": str,                 # 订单类型：MARKET-市价，LIMIT-限价
    "quantity": int,                   # 交易数量（股）
    "price": float,                    # 成交价格
    "amount": float,                   # 成交金额
    "commission": float,               # 手续费
    "stamp_tax": float,                # 印花税
    "transfer_fee": float,             # 过户费
    "slippage": float,                 # 滑点费用
    "total_cost": float,               # 总成本（含各种费用）
    "trade_source": str,               # 交易来源：MANUAL-手动，STRATEGY-策略
    "strategy_name": str,              # 策略名称（如果是策略交易）
    "trade_time": datetime,            # 交易时间
    "settlement_date": date,           # 交割日期（T+1）
    "status": str,                     # 状态：PENDING-待成交，FILLED-已成交，CANCELLED-已撤销
    "remarks": str                     # 备注
}
```

### 2.4 账户历史快照表 (account_snapshots)
```python
{
    "_id": ObjectId,
    "user_id": str,                    # 用户ID
    "snapshot_date": date,             # 快照日期
    "total_assets": float,             # 总资产
    "available_cash": float,           # 可用现金
    "total_market_value": float,       # 持仓总市值
    "daily_return": float,             # 日收益
    "daily_return_rate": float,        # 日收益率
    "cumulative_return": float,        # 累计收益
    "cumulative_return_rate": float,   # 累计收益率
    "position_count": int,             # 持仓数量
    "trade_count": int,                # 当日交易次数
    "create_time": datetime            # 创建时间
}
```

## 3. 交易规则设计

### 3.1 A股交易规则
- **T+1交易制度**: 当日买入的股票次日才能卖出
- **最小交易单位**: 
  - 主板/创业板: 100股（1手）
  - 科创板: 200股（2手）
- **涨跌停限制**: 
  - 主板: ±10%
  - 创业板: ±20%
  - 科创板: ±20%
  - 北交所：±30%
  - ST股票: ±5%

### 3.2 费用结构
```python
# 费用计算配置
TRADING_FEES = {
    "commission_rate": 0.0001,      # 万1手续费
    "commission_min": 5.0,          # 最低5元手续费
    "stamp_tax_rate": 0.001,        # 千1印花税（仅卖出）
    "transfer_fee_rate": 0.00002,   # 万0.2过户费（双向）
    "slippage_rate": 0.001          # 千1滑点（双向）
}
```

### 3.3 费用计算公式
```python
def calculate_trading_cost(amount: float, trade_type: str) -> dict:
    """计算交易成本"""
    # 手续费（双向）
    commission = max(amount * COMMISSION_RATE, COMMISSION_MIN)
    
    # 印花税（仅卖出）
    stamp_tax = amount * STAMP_TAX_RATE if trade_type == 'SELL' else 0
    
    # 过户费（双向，仅沪市）
    transfer_fee = amount * TRANSFER_FEE_RATE
    
    # 滑点费（双向）
    slippage = amount * SLIPPAGE_RATE
    
    total_cost = commission + stamp_tax + transfer_fee + slippage
    
    return {
        'commission': commission,
        'stamp_tax': stamp_tax,
        'transfer_fee': transfer_fee,
        'slippage': slippage,
        'total_cost': total_cost
    }
```

## 4. API接口设计

### 4.1 模拟账户相关接口
```python
# 获取模拟账户信息
GET /api/simulation/account/{user_id}

# 初始化模拟账户
POST /api/simulation/account/init

# 重置模拟账户
POST /api/simulation/account/reset/{user_id}

# 获取账户历史快照
GET /api/simulation/account/{user_id}/snapshots
```

### 4.2 持仓相关接口
```python
# 获取用户持仓列表
GET /api/simulation/positions/{user_id}

# 获取单只股票持仓详情
GET /api/simulation/positions/{user_id}/{stock_code}
```

### 4.3 交易相关接口
```python
# 提交买入订单
POST /api/simulation/trade/buy

# 提交卖出订单
POST /api/simulation/trade/sell

# 获取交易记录
GET /api/simulation/trades/{user_id}

# 撤销挂单
DELETE /api/simulation/trade/{trade_id}
```

### 4.4 行情数据接口
```python
# 获取实时股价
GET /api/simulation/quote/{stock_code}

# 批量获取股价
POST /api/simulation/quotes

# 获取交易日历
GET /api/simulation/calendar
```

## 5. 前端界面设计

### 5.1 Dashboard页面卡片改造
将现有的4个模拟数据卡片改为真实模拟交易数据：

```vue
<!-- 投资组合总价值卡片 -->
<SimulationCard 
  title="投资组合总价值" 
  :value="account.total_assets"
  :change="account.daily_return"
  :changeRate="account.daily_return_rate"
  icon="CurrencyDollarIcon"
/>

<!-- 每日收益卡片 -->
<SimulationCard 
  title="每日收益" 
  :value="account.daily_return"
  :change="account.daily_return"
  :changeRate="account.daily_return_rate"
  icon="TrendingUpIcon"
/>

<!-- 持仓股数卡片 -->
<SimulationCard 
  title="持仓股数" 
  :value="positions.length"
  icon="ChartBarIcon"
/>

<!-- 预测准确率卡片 -->
<SimulationCard 
  title="预测准确率" 
  :value="account.win_rate"
  format="percentage"
  icon="TargetIcon"
/>
```

### 5.2 用户资料页面交易面板
在用户资料页面添加模拟交易功能面板：

```vue
<template>
  <div class="simulation-trading-panel">
    <!-- 账户概览 -->
    <AccountOverview :account="simulationAccount" />
    
    <!-- 持仓列表 -->
    <PositionsTable :positions="positions" @sell="handleSell" />
    
    <!-- 交易面板 -->
    <TradingPanel @buy="handleBuy" @sell="handleSell" />
    
    <!-- 交易记录 -->
    <TradeHistory :trades="trades" />
    
    <!-- 股票池集成 -->
    <StockPoolIntegration @select-stock="handleStockSelect" />
  </div>
</template>
```

## 6. 分阶段实现计划

### 第一阶段：基础框架搭建（当前阶段）
1. **数据库表结构创建**
   - 创建模拟账户、持仓、交易记录等表
   - 设计索引优化查询性能

2. **基础API接口开发**
   - 账户初始化和查询接口
   - 持仓查询接口
   - 基础的买卖交易接口

3. **Dashboard卡片改造**
   - 修改4个卡片的数据来源
   - 实现真实模拟账户数据展示
   - 添加实时更新机制

4. **用户初始化**
   - 为所有用户自动创建模拟账户
   - 初始资金300万设置
   - 账户状态管理

### 第二阶段：交易功能完善
1. **完整的交易系统**
   - 买入/卖出逻辑完善
   - T+1规则实现
   - 费用计算系统

2. **用户界面开发**
   - 交易面板UI设计
   - 持仓管理界面
   - 交易记录查询

3. **与股票池集成**
   - 从股票池选择股票交易
   - 股票池数据与交易系统对接

### 第三阶段：量化策略自动化交易（当前阶段）

基于现有的太上老君1号、2号、3号量化策略，通过轻量级集成实现策略自动化交易。

#### 3.1 策略分析与设计理念

**现有策略特点分析**：
- **太上老君1号（多趋势共振策略）**：每日检查信号，多时间周期确认，最多8只股票，单股最大12%仓位，6%止损/12%止盈
- **太上老君2号（好奇布偶猫BOLL策略）**：每日检查布林带突破，单股固定20万投资，10%止损/15%止盈
- **太上老君3号（小市值动量策略）**：每5日调仓，3因子评分选股，最多25只股票，15%止损/30%止盈

**设计理念**：
- **无重复设计**：策略已内置完整的交易频率、风险控制、仓位管理逻辑
- **轻量级集成**：只做信号桥接，复用现有backtest和simulation系统
- **保持策略完整性**：所有策略特性完全保留，不重新实现

#### 3.2 核心组件设计

**1. 策略适配器（StrategySimulationAdapter）**
```python
class StrategySimulationAdapter:
    """策略模拟交易适配器 - 轻量级实现"""
    
    def __init__(self, user_id: str, strategy_name: str):
        self.user_id = user_id
        self.strategy_name = strategy_name
        self.simulation_service = simulation_service
        
    async def execute_strategy_signals(self, signals: List[dict]):
        """执行策略信号转换为模拟交易"""
        for signal in signals:
            if signal['action'] == 'BUY':
                await self.simulation_service.execute_buy_order(
                    self.user_id, 
                    BuyRequest(
                        stock_code=signal['stock_code'],
                        quantity=signal['quantity'],
                        order_type=OrderType.MARKET,
                        trade_source="STRATEGY",
                        strategy_name=self.strategy_name
                    )
                )
            elif signal['action'] == 'SELL':
                await self.simulation_service.execute_sell_order(
                    self.user_id,
                    SellRequest(
                        stock_code=signal['stock_code'], 
                        quantity=signal['quantity'],
                        order_type=OrderType.MARKET,
                        trade_source="STRATEGY",
                        strategy_name=self.strategy_name
                    )
                )
```

**2. 策略运行器（StrategyRunner）**
```python
class StrategyRunner:
    """策略运行器 - 复用现有回测引擎"""
    
    async def run_strategy_realtime(self, user_id: str, strategy_config: dict):
        """实时运行策略（利用现有backtest_unified.py）"""
        
        # 1. 调用现有的统一回测API，获取当日信号
        backtest_request = {
            "strategy_name": strategy_config['strategy_name'],
            "start_date": datetime.now().strftime('%Y-%m-%d'),
            "end_date": datetime.now().strftime('%Y-%m-%d'),
            "initial_cash": strategy_config.get('allocated_cash', 300000),
            **strategy_config.get('params', {})
        }
        
        # 2. 运行单日策略获取交易信号
        signals = await self.get_daily_signals(backtest_request)
        
        # 3. 转换为模拟交易订单
        adapter = StrategySimulationAdapter(user_id, strategy_config['strategy_name'])
        await adapter.execute_strategy_signals(signals)
```

**3. 定时调度器（StrategyScheduler）**
```python
from apscheduler.schedulers.asyncio import AsyncIOScheduler

class StrategyScheduler:
    """策略定时调度器"""
    
    def start_user_strategy(self, user_id: str, strategy_config: dict):
        """启动用户策略自动交易"""
        job_id = f"strategy_{user_id}_{strategy_config['strategy_name']}"
        
        # 根据策略的内置调仓频率设置定时任务
        if strategy_config['strategy_name'] == 'taishang_3':
            # 太上老君3号：每5个交易日
            self.scheduler.add_job(
                self.strategy_runner.run_strategy_realtime,
                'cron', day_of_week='mon-fri', hour=9, minute=35,
                args=[user_id, strategy_config], id=job_id
            )
        else:
            # 太上老君1号、2号：每日检查
            self.scheduler.add_job(
                self.strategy_runner.run_strategy_realtime,
                'cron', day_of_week='mon-fri', hour=9, minute=35,
                args=[user_id, strategy_config], id=job_id
            )
```

#### 3.3 数据库扩展（最小化）

**用户策略配置表（user_strategy_configs）**
```python
{
    "_id": ObjectId,
    "user_id": str,                    # 用户ID
    "strategy_name": str,              # 策略名称（taishang_1/2/3）
    "is_active": bool,                 # 是否启用自动交易
    "allocated_cash": float,           # 分配给策略的资金
    "custom_params": dict,             # 用户自定义参数（可选）
    "created_time": datetime,          # 创建时间
    "last_execution": datetime,        # 最后执行时间
    "execution_count": int,            # 执行次数
    "total_trades": int,               # 总交易次数
    "current_positions": list          # 当前持仓列表
}
```

#### 3.4 API接口扩展（最小化）

在现有`simulation.py`中新增策略自动化相关接口：

```python
@router.post("/strategy/activate", summary="激活策略自动交易")
async def activate_strategy(
    strategy_name: str,
    allocated_cash: float = Query(..., description="分配资金"),
    custom_params: Optional[dict] = None,
    current_user: dict = Depends(get_current_user)
):
    """激活策略自动交易"""
    pass

@router.post("/strategy/deactivate", summary="停止策略自动交易")  
async def deactivate_strategy(
    strategy_name: str,
    current_user: dict = Depends(get_current_user)
):
    """停止策略自动交易"""
    pass

@router.get("/strategy/status", summary="查看策略运行状态")
async def get_strategy_status(current_user: dict = Depends(get_current_user)):
    """查看用户的策略运行状态和持仓"""
    pass

@router.get("/strategy/performance", summary="策略表现分析")
async def get_strategy_performance(
    strategy_name: str,
    days: int = Query(default=30, description="分析天数"),
    current_user: dict = Depends(get_current_user)
):
    """获取策略执行表现分析"""
    pass
```

#### 3.5 前端界面设计

**策略自动化管理页面**
```vue
<template>
  <div class="strategy-automation-panel">
    <!-- 策略选择卡片 -->
    <el-row :gutter="20">
      <el-col :span="8" v-for="strategy in strategies" :key="strategy.name">
        <el-card class="strategy-card">
          <div slot="header">
            <span>{{ strategy.displayName }}</span>
            <el-switch
              v-model="strategy.isActive"
              @change="toggleStrategy(strategy)"
              style="float: right"
            />
          </div>
          
          <div class="strategy-info">
            <p><strong>调仓频率：</strong>{{ strategy.frequency }}</p>
            <p><strong>风险控制：</strong>{{ strategy.riskControl }}</p>
            <p><strong>适合资金：</strong>{{ strategy.suitableFunds }}</p>
            
            <el-form-item label="分配资金">
              <el-input-number
                v-model="strategy.allocatedCash"
                :min="50000"
                :max="1000000"
                :step="10000"
                :disabled="strategy.isActive"
              />
            </el-form-item>
          </div>
          
          <div class="strategy-performance" v-if="strategy.isActive">
            <h4>运行状态</h4>
            <p>持仓数量：{{ strategy.currentPositions }}只</p>
            <p>累计收益：<span :class="strategy.totalReturn >= 0 ? 'profit' : 'loss'">
              {{ (strategy.totalReturn * 100).toFixed(2) }}%
            </span></p>
            <p>最后执行：{{ strategy.lastExecution }}</p>
          </div>
        </el-card>
      </el-col>
    </el-row>
    
    <!-- 策略持仓概览 -->
    <el-card title="策略持仓概览" style="margin-top: 20px;">
      <el-table :data="strategyPositions" stripe>
        <el-table-column prop="strategy_name" label="策略名称" width="150" />
        <el-table-column prop="stock_code" label="股票代码" width="100" />
        <el-table-column prop="stock_name" label="股票名称" width="120" />
        <el-table-column prop="quantity" label="持仓数量" width="100" />
        <el-table-column prop="current_price" label="现价" width="80" />
        <el-table-column prop="market_value" label="市值" width="100" />
        <el-table-column prop="unrealized_pnl_rate" label="浮动盈亏" width="100">
          <template slot-scope="scope">
            <span :class="scope.row.unrealized_pnl_rate >= 0 ? 'profit' : 'loss'">
              {{ (scope.row.unrealized_pnl_rate * 100).toFixed(2) }}%
            </span>
          </template>
        </el-table-column>
        <el-table-column prop="trade_source" label="来源" width="80" />
      </el-table>
    </el-card>
    
    <!-- 策略交易记录 -->
    <el-card title="策略交易记录" style="margin-top: 20px;">
      <el-table :data="strategyTrades" stripe>
        <el-table-column prop="trade_time" label="交易时间" width="150" />
        <el-table-column prop="strategy_name" label="策略" width="120" />
        <el-table-column prop="stock_code" label="股票" width="100" />
        <el-table-column prop="trade_type" label="类型" width="80" />
        <el-table-column prop="quantity" label="数量" width="80" />
        <el-table-column prop="price" label="价格" width="80" />
        <el-table-column prop="amount" label="金额" width="100" />
        <el-table-column prop="status" label="状态" width="80" />
      </el-table>
    </el-card>
  </div>
</template>

<script>
export default {
  name: 'StrategyAutomation',
  data() {
    return {
      strategies: [
        {
          name: 'taishang_1',
          displayName: '太上老君1号',
          frequency: '每日检查',
          riskControl: '6%止损/12%止盈',
          suitableFunds: '50万-300万',
          allocatedCash: 300000,
          isActive: false,
          currentPositions: 0,
          totalReturn: 0,
          lastExecution: null
        },
        {
          name: 'taishang_2', 
          displayName: '太上老君2号',
          frequency: '每日检查',
          riskControl: '10%止损/15%止盈',
          suitableFunds: '100万-500万',
          allocatedCash: 400000,
          isActive: false,
          currentPositions: 0,
          totalReturn: 0,
          lastExecution: null
        },
        {
          name: 'taishang_3',
          displayName: '太上老君3号', 
          frequency: '每5日调仓',
          riskControl: '15%止损/30%止盈',
          suitableFunds: '200万-1000万',
          allocatedCash: 500000,
          isActive: false,
          currentPositions: 0,
          totalReturn: 0,
          lastExecution: null
        }
      ],
      strategyPositions: [],
      strategyTrades: []
    }
  },
  methods: {
    async toggleStrategy(strategy) {
      if (strategy.isActive) {
        await this.activateStrategy(strategy);
      } else {
        await this.deactivateStrategy(strategy);
      }
    },
    
    async activateStrategy(strategy) {
      try {
        await this.$api.post('/api/simulation/strategy/activate', {
          strategy_name: strategy.name,
          allocated_cash: strategy.allocatedCash
        });
        this.$message.success(`${strategy.displayName} 已启动自动交易`);
        await this.loadStrategyStatus();
      } catch (error) {
        strategy.isActive = false;
        this.$message.error('启动失败: ' + error.message);
      }
    },
    
    async deactivateStrategy(strategy) {
      try {
        await this.$api.post('/api/simulation/strategy/deactivate', {
          strategy_name: strategy.name
        });
        this.$message.success(`${strategy.displayName} 已停止自动交易`);
        await this.loadStrategyStatus();
      } catch (error) {
        strategy.isActive = true;
        this.$message.error('停止失败: ' + error.message);
      }
    },
    
    async loadStrategyStatus() {
      // 加载策略运行状态
    }
  }
}
</script>
```

#### 3.6 实施优势

1. **开发成本低**：只需要编写适配器和调度器，预计2-3天完成
2. **维护简单**：没有重复的风控和仓位管理逻辑，减少维护负担
3. **风险可控**：完全依赖策略内置的经过验证的风控机制
4. **扩展性好**：新增策略只需添加适配器配置即可
5. **用户友好**：简洁的界面，清晰的策略特点展示

#### 3.7 实施计划

**第一步：核心适配器开发**（2天）
1. 开发StrategySimulationAdapter和StrategyRunner
2. 建立用户策略配置数据库表
3. 实现基础的策略信号转换功能

**第二步：定时调度系统**（1天）
1. 集成APScheduler定时任务系统
2. 根据策略内置频率设置调度规则
3. 实现策略启停控制逻辑

**第三步：API接口开发**（1天）
1. 在simulation.py中新增策略管理接口
2. 实现策略状态查询和性能分析接口
3. 完善错误处理和日志记录

**第四步：前端界面开发**（2-3天）
1. 开发策略自动化管理页面
2. 实现策略持仓和交易记录展示
3. 集成到现有的模拟交易界面中

**第五步：测试和优化**（1-2天）
1. 全流程功能测试和bug修复
2. 性能优化和用户体验调整
3. 文档更新和交付

### 第四阶段：高级功能
1. **数据分析**
   - 交易分析报告
   - 策略效果评估
   - 收益归因分析

2. **用户体验优化**
   - 实时行情推送
   - 交易提醒通知
   - 移动端适配

## 7. 技术实现要点

### 7.1 数据一致性保证
- 使用数据库事务确保账户资金和持仓数据一致性
- 实现乐观锁机制防止并发交易冲突
- 定期数据校验和修复机制

### 7.2 性能优化策略
- 股价数据缓存机制（Redis）
- 账户数据缓存和增量更新
- 批量计算持仓市值
- 异步任务处理交易记录

### 7.3 实时数据更新
- 定时任务更新股价数据（每分钟或每5分钟）
- WebSocket推送实时账户变化
- 增量数据同步机制

### 7.4 测试策略
- 单元测试覆盖核心交易逻辑
- 集成测试验证完整交易流程
- 压力测试验证系统性能
- 模拟各种异常情况的处理

## 8. 风险控制

### 8.1 技术风险
- 数据库事务失败处理
- 网络异常的重试机制
- 股价数据异常的处理
- 系统宕机的数据恢复

### 8.2 业务风险
- 交易时间控制
- 异常交易的监控和阻止
- 用户操作权限控制
- 数据篡改防护

## 9. 扩展性考虑

### 9.1 多市场支持
- 预留港股、美股等市场的扩展接口
- 不同市场交易规则的配置化

### 9.2 高级订单类型
- 条件单（止损、止盈）
- 算法交易订单
- 组合交易功能

### 9.3 社交功能
- 交易策略分享
- 高手榜单
- 模拟炒股比赛

## 10. 总结

本模拟交易系统设计充分考虑了A股市场的实际交易规则，与现有的股票池和策略系统深度集成，为用户提供真实的模拟交易体验。通过分阶段实施，可以逐步完善功能，最终构建成完整的模拟交易平台。

该系统不仅能够验证投资策略的有效性，还能帮助用户提升实际的投资能力，为后续可能的实盘交易功能奠定基础。