# 📅 macOS定时任务设置说明

## 概述

本文档介绍如何在macOS系统上设置每日增量更新的定时任务，确保系统在每个交易日晚上7:30自动执行数据更新。

## 🚀 快速设置

### 1. 一键设置定时任务

```bash
# 在项目根目录执行
./setup_cron_macos.sh
```

设置脚本会自动：
- ✅ 检查conda环境和项目配置
- ✅ 创建执行脚本和日志目录
- ✅ 设置crontab定时任务（每天19:30）
- ✅ 测试执行脚本功能

### 2. 管理定时任务

```bash
# 查看定时任务状态
./manage_cron.sh status

# 查看执行日志
./manage_cron.sh logs

# 测试执行脚本
./manage_cron.sh test

# 启用/禁用定时任务
./manage_cron.sh enable
./manage_cron.sh disable

# 删除定时任务
./manage_cron.sh remove
```

## 📋 系统工作原理

### 定时任务流程

```
每天19:30 → crontab → run_daily_update.sh → daily_update_scheduler.py
                                                        ↓
                                            判断是否为交易日
                                                        ↓
                                    是: 执行增量更新  |  否: 跳过并记录
```

### 智能交易日判断

系统会自动：
1. **从数据库获取交易日历**（优先）
2. **从Tushare API获取**（备用）
3. **使用简化判断**（最后备用）

只有在确认为交易日时才会执行数据采集，非交易日会跳过并记录日志。

## 📁 文件结构

```
项目根目录/
├── setup_cron_macos.sh           # 定时任务设置脚本
├── manage_cron.sh                # 定时任务管理脚本
├── run_daily_update.sh           # 实际执行脚本（自动生成）
├── daily_update_scheduler.py     # 增量更新调度器
└── logs/                         # 日志目录
    └── daily_update_YYYYMMDD.log # 每日执行日志
```

## 🔧 详细配置

### 定时任务配置

- **执行时间**: 每天晚上19:30
- **执行频率**: 每日（但只在交易日实际更新）
- **crontab格式**: `30 19 * * * /path/to/run_daily_update.sh`

### 环境要求

1. **conda环境**: 需要 `kk_stock` 环境
2. **Python包**: tushare, pandas, pymongo等
3. **数据库**: MongoDB服务运行中
4. **网络**: 能访问Tushare API

### 日志管理

- **日志位置**: `logs/daily_update_YYYYMMDD.log`
- **日志内容**: 执行时间、交易日判断、更新结果
- **自动清理**: 保留30天的日志文件
- **日志格式**: 包含时间戳和详细执行过程

## 📊 监控与维护

### 日常检查

```bash
# 检查定时任务状态
./manage_cron.sh status

# 查看最近的执行日志
./manage_cron.sh logs

# 查看crontab设置
crontab -l

# 查看今日日志
tail -f logs/daily_update_$(date +%Y%m%d).log
```

### 故障排查

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 定时任务未执行 | crontab未设置 | 运行 `./setup_cron_macos.sh` |
| 环境激活失败 | conda路径问题 | 检查 `run_daily_update.sh` 中的conda路径 |
| 数据库连接失败 | MongoDB未启动 | 启动MongoDB服务 |
| 交易日判断错误 | 交易日历数据缺失 | 运行交易日历采集任务 |

### 常见问题

#### Q1: 如何修改执行时间？

A: 编辑crontab或重新运行设置脚本：

```bash
# 方法1: 直接编辑
crontab -e

# 方法2: 重新设置
./manage_cron.sh remove
./setup_cron_macos.sh
```

#### Q2: 如何查看执行历史？

A: 查看日志目录：

```bash
# 查看所有日志文件
ls -la logs/daily_update_*.log

# 查看特定日期的日志
cat logs/daily_update_20250622.log
```

#### Q3: 如何手动触发更新？

A: 多种方式：

```bash
# 方法1: 直接运行执行脚本
./run_daily_update.sh

# 方法2: 使用管理脚本测试
./manage_cron.sh test

# 方法3: 强制执行增量更新
python daily_update_scheduler.py --force
```

#### Q4: 如何临时禁用定时任务？

A: 使用管理脚本：

```bash
# 禁用（注释掉）
./manage_cron.sh disable

# 重新启用
./manage_cron.sh enable
```

## 🔍 日志示例

### 交易日执行日志

```
========================================
开始时间: 2025-06-23 19:30:01
========================================
✅ 成功激活kk_stock环境
🚀 开始执行增量更新...
📅 每日增量更新调度器
============================================================
🕐 当前时间: 2025-06-23 19:30:02 Monday
📊 交易日历来源: 数据库
📅 今日交易状态: 🟢 交易日
✅ 今天是交易日 (2025-06-23 Monday)
🚀 开始执行交易日增量更新...

[1/4] 📋 股票和指数日线数据增量更新
----------------------------------------
✅ daily_update 更新成功 (耗时: 125.3秒)

[2/4] 📋 股指期货数据增量更新
----------------------------------------
✅ stock_index_futures 更新成功 (耗时: 45.2秒)

📊 增量更新完成: 4/4 个任务成功
✅ 增量更新执行成功
========================================
结束时间: 2025-06-23 19:35:15
========================================
```

### 非交易日跳过日志

```
========================================
开始时间: 2025-06-22 19:30:01
========================================
✅ 成功激活kk_stock环境
🚀 开始执行增量更新...
📅 每日增量更新调度器
============================================================
🕐 当前时间: 2025-06-22 19:30:02 Sunday
📊 交易日历来源: 数据库
📅 今日交易状态: 🔴 休市日
⏸️ 今天不是交易日 (2025-06-22 Sunday)
💤 跳过数据更新
📈 最近交易日: 20250620
📅 未来交易日: 20250623, 20250624, 20250625
✅ 增量更新执行成功
========================================
结束时间: 2025-06-22 19:30:03
========================================
```

## 🎯 最佳实践

### 1. 生产环境建议

- ✅ 定期检查日志，确保执行正常
- ✅ 监控磁盘空间，避免日志文件过多
- ✅ 设置邮件通知（可选）
- ✅ 备份重要配置文件

### 2. 开发环境建议

- ✅ 使用测试模式验证功能
- ✅ 调整执行时间避免冲突
- ✅ 保留详细日志便于调试

### 3. 系统维护

- ✅ 定期更新交易日历数据
- ✅ 检查conda环境完整性
- ✅ 验证数据库连接状态
- ✅ 监控API调用频率

## 📞 技术支持

如遇到问题，请：

1. 查看执行日志：`./manage_cron.sh logs`
2. 检查系统状态：`./manage_cron.sh status`
3. 测试执行脚本：`./manage_cron.sh test`
4. 参考故障排查表格

---

## 📝 总结

通过本文档的设置，您的系统将能够：

- 🎯 **智能执行**: 只在交易日进行数据更新
- 🔄 **自动化**: 无需人工干预的定时执行
- 📊 **可监控**: 详细的日志和状态检查
- 🛠️ **易管理**: 简单的命令行管理工具
- 🔧 **可维护**: 完善的故障排查机制

系统现已准备就绪，将在每个交易日晚上7:30自动执行增量数据更新！ 