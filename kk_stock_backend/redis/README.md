# Redisç¼“å­˜ç³»ç»Ÿ

æœ¬ç›®å½•åŒ…å«è‚¡ç¥¨é‡åŒ–åˆ†æç³»ç»Ÿçš„Redisç¼“å­˜æœåŠ¡é…ç½®å’Œéƒ¨ç½²è„šæœ¬ã€‚

## ğŸ“ ç›®å½•ç»“æ„

```
redis/
â”œâ”€â”€ README.md                    # æœ¬æ–‡ä»¶ - ç³»ç»Ÿæ¦‚è¿°
â”œâ”€â”€ QUICK_START.md              # å¿«é€Ÿå¯åŠ¨æŒ‡å—
â”œâ”€â”€ REDIS_DEPLOYMENT_GUIDE.md   # å®Œæ•´éƒ¨ç½²æ–‡æ¡£
â”œâ”€â”€ TROUBLESHOOTING.md          # æ•…éšœæ’é™¤æŒ‡å—
â”œâ”€â”€ docker-compose.redis.yml    # Docker Composeé…ç½®
â”œâ”€â”€ redis.conf                  # RedisæœåŠ¡å™¨é…ç½®
â”œâ”€â”€ deploy_redis.sh             # è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬ï¼ˆæ¨èï¼‰
â”œâ”€â”€ deploy_redis_offline.sh     # ç¦»çº¿éƒ¨ç½²è„šæœ¬
â”œâ”€â”€ fix_network_issues.sh       # ç½‘ç»œé—®é¢˜ä¿®å¤è„šæœ¬
â””â”€â”€ check_environment.sh        # ç¯å¢ƒæ£€æŸ¥è„šæœ¬
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ä¸€é”®éƒ¨ç½²

```bash
# 1. è¿›å…¥redisç›®å½•
cd redis

# 2. è¿è¡Œéƒ¨ç½²è„šæœ¬
./deploy_redis.sh
```

### éªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker-compose -f docker-compose.redis.yml ps

# æµ‹è¯•Redisè¿æ¥
docker exec kk_redis_cache redis-cli ping
```

## ğŸ“‹ æ–‡ä»¶è¯´æ˜

### æ ¸å¿ƒé…ç½®æ–‡ä»¶

#### `docker-compose.redis.yml`
- **ç”¨é€”**: Docker ComposeæœåŠ¡ç¼–æ’é…ç½®
- **åŒ…å«æœåŠ¡**:
  - `redis`: Redisç¼“å­˜æœåŠ¡å™¨ (ç«¯å£6379)
  - `redis-commander`: Webç®¡ç†ç•Œé¢ (ç«¯å£8081)
- **ç‰¹æ€§**:
  - æ•°æ®æŒä¹…åŒ–
  - å¥åº·æ£€æŸ¥
  - è‡ªåŠ¨é‡å¯
  - ç½‘ç»œéš”ç¦»

#### `redis.conf`
- **ç”¨é€”**: RedisæœåŠ¡å™¨è¯¦ç»†é…ç½®
- **ä¸»è¦é…ç½®**:
  - å†…å­˜ç®¡ç†ç­–ç•¥
  - æŒä¹…åŒ–è®¾ç½® (RDB + AOF)
  - ç½‘ç»œå’Œå®‰å…¨é…ç½®
  - æ€§èƒ½ä¼˜åŒ–å‚æ•°

### è‡ªåŠ¨åŒ–è„šæœ¬

#### `deploy_redis.sh` (æ¨è)
- **ç”¨é€”**: æ™ºèƒ½ä¸€é”®éƒ¨ç½²RedisæœåŠ¡
- **åŠŸèƒ½**:
  - ç¯å¢ƒæ£€æŸ¥
  - è‡ªåŠ¨ç½‘ç»œé—®é¢˜ä¿®å¤
  - æœåŠ¡éƒ¨ç½²
  - å¥åº·éªŒè¯
  - ä¿¡æ¯å±•ç¤º
- **é€‰é¡¹**:
  - `--clean`: æ¸…ç†æ—§æ•°æ®
  - `--backup`: åˆ›å»ºå¤‡ä»½
  - `--test`: è¿è¡Œæµ‹è¯•

#### `deploy_redis_offline.sh`
- **ç”¨é€”**: ç¦»çº¿ç¯å¢ƒéƒ¨ç½²RedisæœåŠ¡
- **é€‚ç”¨åœºæ™¯**:
  - ç½‘ç»œå—é™ç¯å¢ƒ
  - Docker Hubæ— æ³•è®¿é—®
  - é•œåƒæ‹‰å–å¤±è´¥
- **é€‰é¡¹**:
  - `--simple`: ä»…éƒ¨ç½²RedisæœåŠ¡
  - `--check-only`: ä»…æ£€æŸ¥ç¯å¢ƒ

#### `fix_network_issues.sh`
- **ç”¨é€”**: ç½‘ç»œé—®é¢˜è¯Šæ–­å’Œä¿®å¤
- **åŠŸèƒ½**:
  - Dockeré•œåƒæºé…ç½®
  - ç½‘ç»œè¿æ¥æµ‹è¯•
  - ä»£ç†é—®é¢˜æ£€æµ‹
  - ç¼“å­˜æ¸…ç†
- **é€‰é¡¹**:
  - `--clean-only`: ä»…æ¸…ç†ç¼“å­˜
  - `--test-only`: ä»…æµ‹è¯•æ‹‰å–
  - `--mirror-only`: ä»…é…ç½®é•œåƒæº

#### `check_environment.sh`
- **ç”¨é€”**: ç¯å¢ƒä¸€è‡´æ€§æ£€æŸ¥
- **æ£€æŸ¥é¡¹ç›®**:
  - ç³»ç»Ÿè¦æ±‚
  - Dockerç¯å¢ƒ
  - å¿…è¦æ–‡ä»¶
  - ç½‘ç»œè¿æ¥
  - ç°æœ‰æœåŠ¡

### æ–‡æ¡£æ–‡ä»¶

#### `README.md` (æœ¬æ–‡ä»¶)
- ç³»ç»Ÿæ¦‚è¿°å’Œç›®å½•ç»“æ„è¯´æ˜

#### `QUICK_START.md`
- è¯¦ç»†çš„å¿«é€Ÿå¯åŠ¨æŒ‡å—
- å¸¸ç”¨æ“ä½œå‘½ä»¤
- æ•…éšœæ’é™¤æŒ‡å—

## ğŸ”§ æœåŠ¡é…ç½®

### RedisæœåŠ¡
- **å®¹å™¨å**: `kk_redis_cache`
- **é•œåƒ**: `redis:7.0-alpine`
- **ç«¯å£**: `6379`
- **æ•°æ®å·**: `redis_data`
- **é…ç½®æ–‡ä»¶**: `./redis.conf`

### Redis Commander
- **å®¹å™¨å**: `kk_redis_commander`
- **é•œåƒ**: `rediscommander/redis-commander:latest`
- **ç«¯å£**: `8081`
- **è®¿é—®**: http://localhost:8081
- **è®¤è¯**: admin / redis123

### ç½‘ç»œé…ç½®
- **ç½‘ç»œå**: `kk_network`
- **ç±»å‹**: bridge
- **å­ç½‘**: `172.20.0.0/16`

## ğŸ“Š ç›‘æ§å’Œç®¡ç†

### Webç®¡ç†ç•Œé¢
è®¿é—® http://localhost:8081 ä½¿ç”¨Redis Commanderè¿›è¡Œå¯è§†åŒ–ç®¡ç†ï¼š
- å®æ—¶ç›‘æ§RedisçŠ¶æ€
- æµè§ˆå’Œç¼–è¾‘é”®å€¼æ•°æ®
- æ‰§è¡ŒRediså‘½ä»¤
- æŸ¥çœ‹å†…å­˜ä½¿ç”¨æƒ…å†µ

### å‘½ä»¤è¡Œç®¡ç†

```bash
# è¿›å…¥Redis CLI
docker exec -it kk_redis_cache redis-cli

# æŸ¥çœ‹æœåŠ¡ä¿¡æ¯
docker exec kk_redis_cache redis-cli INFO

# ç›‘æ§å®æ—¶å‘½ä»¤
docker exec kk_redis_cache redis-cli MONITOR
```

## ğŸ”„ ä¸APIç³»ç»Ÿé›†æˆ

### ç¼“å­˜é…ç½®
APIç³»ç»Ÿçš„ç¼“å­˜é…ç½®ä½äºï¼š
- `../api/cache_config.py` - ç¼“å­˜ç­–ç•¥é…ç½®
- `../api/cache_manager.py` - ç¼“å­˜ç®¡ç†å™¨
- `../api/cache_middleware.py` - ç¼“å­˜ä¸­é—´ä»¶

### è¿æ¥é…ç½®
APIç³»ç»Ÿé€šè¿‡ä»¥ä¸‹é…ç½®è¿æ¥Redisï¼š

```python
REDIS_CONFIG = {
    'host': 'localhost',
    'port': 6379,
    'db': 0,
    'decode_responses': True
}
```

### ç¼“å­˜ç­–ç•¥
- **è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯**: 24å°æ—¶TTL
- **å®æ—¶è¡Œæƒ…æ•°æ®**: 1åˆ†é’ŸTTL
- **æŠ€æœ¯åˆ†ææ•°æ®**: 30åˆ†é’ŸTTL
- **è´¢åŠ¡æ•°æ®**: 12å°æ—¶TTL

## ğŸš¨ æ•…éšœæ’é™¤

### å¿«é€Ÿè§£å†³æ–¹æ¡ˆ

1. **ç½‘ç»œé—®é¢˜ï¼ˆé•œåƒæ‹‰å–å¤±è´¥ï¼‰**
   ```bash
   # è‡ªåŠ¨ä¿®å¤ç½‘ç»œé—®é¢˜
   ./fix_network_issues.sh
   
   # æˆ–ä½¿ç”¨ç¦»çº¿éƒ¨ç½²
   ./deploy_redis_offline.sh
   ```

2. **æœåŠ¡æ— æ³•å¯åŠ¨**
   ```bash
   # æ£€æŸ¥ç«¯å£å ç”¨
   netstat -tuln | grep 6379
   
   # æŸ¥çœ‹å®¹å™¨æ—¥å¿—
   docker logs kk_redis_cache
   
   # é‡æ–°éƒ¨ç½²
   ./deploy_redis.sh --clean
   ```

3. **è¿æ¥è¶…æ—¶**
   ```bash
   # æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
   sudo ufw status
   
   # æ£€æŸ¥Dockerç½‘ç»œ
   docker network ls
   
   # è¿è¡Œç¯å¢ƒæ£€æŸ¥
   ./check_environment.sh
   ```

### è¯¦ç»†æ•…éšœæ’é™¤

æŸ¥çœ‹å®Œæ•´çš„æ•…éšœæ’é™¤æŒ‡å—ï¼š[TROUBLESHOOTING.md](./TROUBLESHOOTING.md)

### è·å–å¸®åŠ©

```bash
# è¿è¡Œç¯å¢ƒæ£€æŸ¥
./check_environment.sh

# ç½‘ç»œé—®é¢˜ä¿®å¤
./fix_network_issues.sh --help

# ç¦»çº¿éƒ¨ç½²é€‰é¡¹
./deploy_redis_offline.sh --help

# æŸ¥çœ‹éƒ¨ç½²è„šæœ¬å¸®åŠ©
./deploy_redis.sh --help
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### å†…å­˜ä¼˜åŒ–
- é…ç½®åˆé€‚çš„ `maxmemory` é™åˆ¶
- ä½¿ç”¨ `allkeys-lru` æ·˜æ±°ç­–ç•¥
- å®šæœŸæ¸…ç†è¿‡æœŸé”®

### æŒä¹…åŒ–ä¼˜åŒ–
- RDB + AOF åŒé‡ä¿éšœ
- åˆç†è®¾ç½®ä¿å­˜é¢‘ç‡
- å®šæœŸå¤‡ä»½æ•°æ®

### ç½‘ç»œä¼˜åŒ–
- ä½¿ç”¨è¿æ¥æ± 
- å¯ç”¨TCP keepalive
- è°ƒæ•´è¶…æ—¶å‚æ•°

## ğŸ”’ å®‰å…¨é…ç½®

### ç”Ÿäº§ç¯å¢ƒå»ºè®®
1. **è®¾ç½®å¯†ç ä¿æŠ¤**
   ```bash
   # åœ¨redis.confä¸­è®¾ç½®
   requirepass your_strong_password
   ```

2. **ç½‘ç»œè®¿é—®æ§åˆ¶**
   ```bash
   # é™åˆ¶ç»‘å®šåœ°å€
   bind 127.0.0.1
   ```

3. **ç¦ç”¨å±é™©å‘½ä»¤**
   ```bash
   # é‡å‘½åå±é™©å‘½ä»¤
   rename-command FLUSHDB ""
   rename-command FLUSHALL ""
   ```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å®Œæ•´éƒ¨ç½²æŒ‡å—](./REDIS_DEPLOYMENT_GUIDE.md)
- [å¿«é€Ÿå¯åŠ¨æŒ‡å—](./QUICK_START.md)
- [APIç¼“å­˜è®¾è®¡](../api/REDIS_SETUP.md)
- [Rediså®˜æ–¹æ–‡æ¡£](https://redis.io/documentation)

## ğŸ¤ è´¡çŒ®æŒ‡å—

å¦‚éœ€ä¿®æ”¹Redisé…ç½®æˆ–è„šæœ¬ï¼š

1. ä¿®æ”¹ç›¸åº”é…ç½®æ–‡ä»¶
2. è¿è¡Œç¯å¢ƒæ£€æŸ¥è„šæœ¬éªŒè¯
3. æµ‹è¯•éƒ¨ç½²æµç¨‹
4. æ›´æ–°ç›¸å…³æ–‡æ¡£

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®éµå¾ªé¡¹ç›®æ ¹ç›®å½•çš„è®¸å¯è¯æ¡æ¬¾ã€‚

---

**Redisç¼“å­˜ç³»ç»Ÿ** - ä¸ºè‚¡ç¥¨é‡åŒ–åˆ†ææä¾›é«˜æ€§èƒ½ç¼“å­˜æ”¯æŒ ğŸš€