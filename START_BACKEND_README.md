# ğŸš€ KKè‚¡ç¥¨é‡åŒ–åˆ†æç³»ç»Ÿåç«¯å¯åŠ¨è„šæœ¬ä½¿ç”¨æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

`start_backend.sh` æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„åç«¯æœåŠ¡ç®¡ç†è„šæœ¬ï¼Œä¸“ä¸º **KKè‚¡ç¥¨é‡åŒ–åˆ†æç³»ç»Ÿåç«¯** è®¾è®¡ã€‚è¯¥è„šæœ¬åŸºäº `Python 3.11 + FastAPI + Uvicorn` æ¶æ„ï¼Œæä¾›å®Œæ•´çš„å¼€å‘ã€ç”Ÿäº§å’Œéƒ¨ç½²è§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒå…¨å±€è·¯å¾„é…ç½®å’Œçµæ´»çš„ç¯å¢ƒç®¡ç†ã€‚

## âœ¨ ä¸»è¦åŠŸèƒ½

### ğŸŒ å…¨å±€è·¯å¾„é…ç½®
- **æ™ºèƒ½è·¯å¾„æ£€æµ‹** - è‡ªåŠ¨æ£€æµ‹é¡¹ç›®æ ¹ç›®å½•å’Œå­ç›®å½•ç»“æ„
- **ç¯å¢ƒå˜é‡æ”¯æŒ** - æ”¯æŒé€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–é»˜è®¤è·¯å¾„é…ç½®
- **è·¯å¾„éªŒè¯** - è‡ªåŠ¨éªŒè¯é¡¹ç›®ç›®å½•ç»“æ„å®Œæ•´æ€§
- **è°ƒè¯•æ¨¡å¼** - æä¾›è·¯å¾„é…ç½®è°ƒè¯•ä¿¡æ¯è¾“å‡º

### ğŸ”§ ç¯å¢ƒç®¡ç†
- **Condaç¯å¢ƒæ£€æŸ¥** - è‡ªåŠ¨æ£€æµ‹å¹¶åˆ›å»ºCondaè™šæ‹Ÿç¯å¢ƒ
- **ä¾èµ–ç®¡ç†** - æ™ºèƒ½å®‰è£…å’Œæ›´æ–°Pythonä¾èµ–åŒ…
- **ç¯å¢ƒå˜é‡é…ç½®** - è‡ªåŠ¨è®¾ç½®APIæœåŠ¡ç›¸å…³ç¯å¢ƒå˜é‡
- **Pythonç‰ˆæœ¬éªŒè¯** - ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„Pythonç‰ˆæœ¬ï¼ˆ3.11ï¼‰

### ğŸš€ æœåŠ¡æ¨¡å¼
- **å‰å°æ¨¡å¼** - å¼€å‘è°ƒè¯•ä½¿ç”¨ï¼Œæ”¯æŒå®æ—¶æ—¥å¿—è¾“å‡º
- **åå°æ¨¡å¼** - ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼Œæ”¯æŒdaemonè¿›ç¨‹ç®¡ç†
- **å¤šWorkeræ”¯æŒ** - æ”¯æŒå•workerå’Œå¤šworkeræ¨¡å¼
- **ç”Ÿäº§çº§é…ç½®** - å®Œæ•´çš„å¹¶å‘è¿æ¥ã€Keep-aliveç­‰é…ç½®

### ğŸ“Š è¿›ç¨‹ç®¡ç†
- **åå°æœåŠ¡ç®¡ç†** - æ”¯æŒå¯åŠ¨ã€åœæ­¢ã€é‡å¯åå°æœåŠ¡
- **PIDæ–‡ä»¶ç®¡ç†** - è‡ªåŠ¨ç®¡ç†è¿›ç¨‹IDæ–‡ä»¶
- **ä¼˜é›…å…³é—­** - æ”¯æŒTERMä¿¡å·ä¼˜é›…åœæ­¢å’ŒKILLå¼ºåˆ¶ç»ˆæ­¢
- **çŠ¶æ€ç›‘æ§** - å®æ—¶æŸ¥çœ‹æœåŠ¡è¿è¡ŒçŠ¶æ€

### ğŸ“ æ—¥å¿—ç³»ç»Ÿ
- **è¯¦ç»†æ—¥å¿—è®°å½•** - å¯åŠ¨/è¿è¡Œ/é”™è¯¯æ—¥å¿—å®Œæ•´è®°å½•
- **æ—¥å¿—åˆ†ç±»ç®¡ç†** - å¯åŠ¨æ—¥å¿—å’Œdaemonæ—¥å¿—åˆ†ç¦»å­˜å‚¨
- **å®æ—¶æ—¥å¿—æŸ¥çœ‹** - æ”¯æŒæ—¥å¿—å®æ—¶è·Ÿè¸ªå’ŒæŸ¥çœ‹
- **è‡ªåŠ¨æ¸…ç†** - 7å¤©å‰çš„æ—¥å¿—è‡ªåŠ¨åˆ é™¤

### âš™ï¸ é«˜çº§é…ç½®
- **å¹¶å‘æ§åˆ¶** - å¯é…ç½®æœ€å¤§å¹¶å‘è¿æ¥æ•°å’Œè¿æ¥é˜Ÿåˆ—é•¿åº¦
- **æ€§èƒ½ä¼˜åŒ–** - Keep-aliveè¶…æ—¶ã€Workeræ•°é‡ç­‰å‚æ•°è°ƒä¼˜
- **ç¯å¢ƒé€‚é…** - æ”¯æŒå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒé…ç½®

## ğŸ› ï¸ ä½¿ç”¨æ–¹æ³•

### åŸºç¡€å‘½ä»¤

```bash
# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ï¼ˆæŸ¥çœ‹å…¨å±€è·¯å¾„é…ç½®ï¼‰
./start_backend.sh --help

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
./start_backend.sh status

# å‰å°å¯åŠ¨æœåŠ¡ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
./start_backend.sh

# åå°å¯åŠ¨æœåŠ¡ï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰
./start_backend.sh --daemon

# åœæ­¢åå°æœåŠ¡
./start_backend.sh stop

# é‡å¯åå°æœåŠ¡
./start_backend.sh restart
```

### é«˜çº§é€‰é¡¹

```bash
# è‡ªå®šä¹‰ä¸»æœºå’Œç«¯å£
./start_backend.sh --host 0.0.0.0 --port 9001 --daemon

# æŒ‡å®šWorkeræ•°é‡ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
./start_backend.sh --workers 8 --daemon

# å•Workeræ¨¡å¼ï¼ˆå¼€å‘è°ƒè¯•ï¼‰
./start_backend.sh --workers 1 --daemon

# å¼ºåˆ¶æ›´æ–°ä¾èµ–åŒ…
./start_backend.sh --update-deps --daemon

# æŒ‡å®šè¿è¡Œç¯å¢ƒ
./start_backend.sh --env production --daemon
```

### å…¨å±€è·¯å¾„é…ç½®

```bash
# ä½¿ç”¨é»˜è®¤è·¯å¾„é…ç½®
./start_backend.sh --daemon

# è‡ªå®šä¹‰é¡¹ç›®æ ¹ç›®å½•
KK_PROJECT_ROOT=/custom/path ./start_backend.sh --daemon

# è‡ªå®šä¹‰åç«¯ç›®å½•
KK_BACKEND_DIR=/custom/backend ./start_backend.sh --daemon

# å¯ç”¨è·¯å¾„è°ƒè¯•ä¿¡æ¯
DEBUG_PATHS=true ./start_backend.sh --debug-paths --daemon
```

### æ—¥å¿—ç®¡ç†

```bash
# æŸ¥çœ‹æœ€æ–°å¯åŠ¨æ—¥å¿—ï¼ˆå®æ—¶è·Ÿè¸ªï¼‰
./start_backend.sh logs

# æŸ¥çœ‹æœ€æ–°åå°è¿è¡Œæ—¥å¿—ï¼ˆå®æ—¶è·Ÿè¸ªï¼‰
./start_backend.sh logs --daemon

# åˆ—å‡ºæ‰€æœ‰æ—¥å¿—æ–‡ä»¶
./start_backend.sh list-logs

# æ¸…ç†7å¤©å‰çš„æ—¥å¿—
./start_backend.sh --clean-logs
```

### æœåŠ¡ç®¡ç†å‘½ä»¤

```bash
# æ˜¾å¼å¯åŠ¨å‘½ä»¤
./start_backend.sh start                    # å‰å°å¯åŠ¨
./start_backend.sh start --daemon           # åå°å¯åŠ¨
./start_backend.sh start --workers 4        # æŒ‡å®šworkeræ•°

# æœåŠ¡çŠ¶æ€ç®¡ç†
./start_backend.sh status                   # æŸ¥çœ‹çŠ¶æ€
./start_backend.sh stop                     # åœæ­¢æœåŠ¡
./start_backend.sh restart                  # é‡å¯æœåŠ¡
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
kk_Stock_Analysis/
â”œâ”€â”€ start_backend.sh           # åç«¯å¯åŠ¨è„šæœ¬
â”œâ”€â”€ kk_stock_backend/          # åç«¯é¡¹ç›®ç›®å½•
â”‚   â”œâ”€â”€ api/                   # APIæ¥å£å±‚
â”‚   â”‚   â”œâ”€â”€ main.py           # APIæœåŠ¡å…¥å£
â”‚   â”‚   â””â”€â”€ routers/          # è·¯ç”±æ¨¡å—ï¼ˆ20+ä¸ªAPIæ¨¡å—ï¼‰
â”‚   â”œâ”€â”€ analysis/             # æ ¸å¿ƒåˆ†æå¼•æ“
â”‚   â”œâ”€â”€ backtrader_strategies/ # é‡åŒ–ç­–ç•¥æ¡†æ¶
â”‚   â”œâ”€â”€ qlib_quantitative/    # Qlibæ·±åº¦å­¦ä¹ æ¡†æ¶
â”‚   â”œâ”€â”€ requirements.txt      # Pythonä¾èµ–
â”‚   â”œâ”€â”€ environment.yml       # Condaç¯å¢ƒé…ç½®
â”‚   â”œâ”€â”€ kk_stock_backend.pid  # PIDæ–‡ä»¶ï¼ˆè¿è¡Œæ—¶åˆ›å»ºï¼‰
â”‚   â””â”€â”€ logs/                 # æ—¥å¿—ç›®å½•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
â”‚       â”œâ”€â”€ startup_*.log     # å¯åŠ¨æ—¥å¿—
â”‚       â””â”€â”€ daemon_*.log      # åå°è¿è¡Œæ—¥å¿—
â””â”€â”€ kk_stock_desktop/         # å‰ç«¯é¡¹ç›®ç›®å½•
```

## ğŸ”§ é…ç½®è¯´æ˜

### é»˜è®¤é…ç½®
- **APIä¸»æœº**: 0.0.0.0ï¼ˆæ‰€æœ‰ç½‘å¡ï¼‰
- **APIç«¯å£**: 9001
- **Workeræ•°é‡**: 4ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- **æœ€å¤§å¹¶å‘è¿æ¥**: 1000
- **Keep-aliveè¶…æ—¶**: 5ç§’
- **è¿æ¥é˜Ÿåˆ—é•¿åº¦**: 2048
- **Pythonç‰ˆæœ¬**: 3.11
- **Condaç¯å¢ƒå**: kk_stock

### ç¯å¢ƒå˜é‡
è„šæœ¬æ”¯æŒä»¥ä¸‹ç¯å¢ƒå˜é‡é…ç½®ï¼š

#### å…¨å±€è·¯å¾„é…ç½®
- `KK_PROJECT_ROOT` - è¦†ç›–é¡¹ç›®æ ¹ç›®å½•è·¯å¾„
- `KK_BACKEND_DIR` - è¦†ç›–åç«¯ç›®å½•è·¯å¾„
- `KK_FRONTEND_DIR` - è¦†ç›–å‰ç«¯ç›®å½•è·¯å¾„
- `DEBUG_PATHS=true` - å¯ç”¨è·¯å¾„è°ƒè¯•ä¿¡æ¯

#### æœåŠ¡é…ç½®
- `API_HOST` - APIæœåŠ¡ä¸»æœºåœ°å€
- `API_PORT` - APIæœåŠ¡ç«¯å£
- `ENVIRONMENT` - è¿è¡Œç¯å¢ƒï¼ˆdevelopment/productionï¼‰
- `UVICORN_WORKERS` - Workerè¿›ç¨‹æ•°é‡
- `UVICORN_LIMIT_CONCURRENCY` - æœ€å¤§å¹¶å‘è¿æ¥æ•°
- `UVICORN_KEEPALIVE` - Keep-aliveè¶…æ—¶æ—¶é—´
- `UVICORN_BACKLOG` - è¿æ¥é˜Ÿåˆ—é•¿åº¦

## ğŸ“Š æœåŠ¡çŠ¶æ€è¯´æ˜

### çŠ¶æ€æ£€æŸ¥è¾“å‡ºç¤ºä¾‹
```
[SUCCESS] æœåŠ¡æ­£åœ¨è¿è¡Œ (PID: 12345)
[INFO] æœåŠ¡åœ°å€: http://0.0.0.0:9001
[INFO] APIæ–‡æ¡£: http://0.0.0.0:9001/docs
[INFO] æ—¥å¿—æ–‡ä»¶: /path/to/logs/daemon_20240804.log
```

### è¿›ç¨‹æ–‡ä»¶
- `kk_stock_backend.pid` - åå°æœåŠ¡è¿›ç¨‹IDæ–‡ä»¶
- ä½ç½®ï¼š`{åç«¯ç›®å½•}/kk_stock_backend.pid`

### APIæ–‡æ¡£è®¿é—®
- **Swagger UI**: `http://localhost:9001/docs`
- **ReDoc**: `http://localhost:9001/redoc`
- **OpenAPIè§„èŒƒ**: `http://localhost:9001/openapi.json`

## ğŸ’¡ æœ€ä½³å®è·µ

### å¼€å‘ç¯å¢ƒå¯åŠ¨
1. **é¦–æ¬¡å¯åŠ¨**ï¼š
   ```bash
   ./start_backend.sh
   ```

2. **åå°å¼€å‘**ï¼ˆæ¨èç”¨äºé•¿æœŸå¼€å‘ï¼‰ï¼š
   ```bash
   ./start_backend.sh --workers 1 --daemon
   ```

3. **è°ƒè¯•æ¨¡å¼**ï¼š
   ```bash
   DEBUG_PATHS=true ./start_backend.sh --debug-paths
   ```

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
1. **å¤šWorkerç”Ÿäº§æ¨¡å¼**ï¼š
   ```bash
   ./start_backend.sh --workers 8 --daemon
   ```

2. **é«˜å¹¶å‘é…ç½®**ï¼š
   ```bash
   UVICORN_LIMIT_CONCURRENCY=2000 UVICORN_BACKLOG=4096 ./start_backend.sh --workers 16 --daemon
   ```

3. **è‡ªå®šä¹‰è·¯å¾„éƒ¨ç½²**ï¼š
   ```bash
   KK_PROJECT_ROOT=/opt/kk_stock ./start_backend.sh --daemon
   ```

### æ—¥å¸¸ç»´æŠ¤
1. **æ£€æŸ¥æœåŠ¡çŠ¶æ€**ï¼š
   ```bash
   ./start_backend.sh status
   ```

2. **æŸ¥çœ‹å®æ—¶æ—¥å¿—**ï¼š
   ```bash
   ./start_backend.sh logs --daemon
   ```

3. **é‡å¯æœåŠ¡**ï¼š
   ```bash
   ./start_backend.sh restart
   ```

4. **æ¸…ç†æ—¥å¿—**ï¼š
   ```bash
   ./start_backend.sh --clean-logs
   ```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ç«¯å£å†²çª**ï¼šç¡®ä¿9001ç«¯å£æœªè¢«å…¶ä»–åº”ç”¨å ç”¨
2. **Condaç¯å¢ƒ**ï¼šéœ€è¦é¢„å…ˆå®‰è£…Anacondaæˆ–Miniconda
3. **Pythonç‰ˆæœ¬**ï¼šæ¨èä½¿ç”¨Python 3.11ç‰ˆæœ¬
4. **ä¾èµ–å®‰è£…**ï¼šé¦–æ¬¡è¿è¡Œéœ€è¦åˆ›å»ºè™šæ‹Ÿç¯å¢ƒå’Œå®‰è£…ä¾èµ–
5. **æƒé™é—®é¢˜**ï¼šè„šæœ¬éœ€è¦å¯æ‰§è¡Œæƒé™ï¼ˆ`chmod +x start_backend.sh`ï¼‰
6. **æ•°æ®åº“è¿æ¥**ï¼šç¡®ä¿MongoDBå’ŒRedisæœåŠ¡æ­£å¸¸è¿è¡Œ
7. **ç¯å¢ƒå˜é‡**ï¼šç”Ÿäº§ç¯å¢ƒéœ€è¦è®¾ç½®Tushare Tokenç­‰APIå¯†é’¥

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ç«¯å£è¢«å ç”¨**ï¼š
   ```bash
   # æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
   lsof -i :9001
   # å¼ºåˆ¶ç»“æŸè¿›ç¨‹
   kill -9 <PID>
   ```

2. **Condaç¯å¢ƒé—®é¢˜**ï¼š
   ```bash
   # é‡æ–°åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
   conda env remove -n kk_stock
   conda env create -f kk_stock_backend/environment.yml
   ```

3. **ä¾èµ–å®‰è£…å¤±è´¥**ï¼š
   ```bash
   # æ‰‹åŠ¨æ¿€æ´»ç¯å¢ƒå¹¶å®‰è£…ä¾èµ–
   conda activate kk_stock
   pip install -r kk_stock_backend/requirements.txt --upgrade
   ```

4. **æœåŠ¡å¯åŠ¨å¤±è´¥**ï¼š
   ```bash
   # æ£€æŸ¥å¯åŠ¨æ—¥å¿—
   ./start_backend.sh logs
   # æˆ–æŸ¥çœ‹å…·ä½“æ—¥å¿—æ–‡ä»¶
   tail -f kk_stock_backend/logs/startup_*.log
   ```

5. **è·¯å¾„é…ç½®é—®é¢˜**ï¼š
   ```bash
   # å¯ç”¨è·¯å¾„è°ƒè¯•
   DEBUG_PATHS=true ./start_backend.sh --debug-paths --help
   ```

### æ€§èƒ½è°ƒä¼˜

1. **Workeræ•°é‡è®¾ç½®**ï¼š
   - å¼€å‘ç¯å¢ƒï¼š1ä¸ªworker
   - æµ‹è¯•ç¯å¢ƒï¼š2-4ä¸ªworker  
   - ç”Ÿäº§ç¯å¢ƒï¼šCPUæ ¸å¿ƒæ•°çš„1-2å€

2. **å†…å­˜ä¼˜åŒ–**ï¼š
   ```bash
   # ç›‘æ§å†…å­˜ä½¿ç”¨
   ps aux | grep uvicorn
   # é€‚å½“è°ƒæ•´workeræ•°é‡
   ```

3. **å¹¶å‘è¿æ¥è°ƒä¼˜**ï¼š
   ```bash
   # é«˜å¹¶å‘åœºæ™¯
   UVICORN_LIMIT_CONCURRENCY=2000 ./start_backend.sh --workers 16 --daemon
   ```

### æ—¥å¿—åˆ†æ
æ‰€æœ‰è¿è¡Œæ—¥å¿—éƒ½ä¿å­˜åœ¨ `kk_stock_backend/logs/` ç›®å½•ä¸‹ï¼š

```bash
# å®æ—¶æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
./start_backend.sh logs

# å®æ—¶æŸ¥çœ‹åå°è¿è¡Œæ—¥å¿—  
./start_backend.sh logs --daemon

# æŸ¥çœ‹å…·ä½“æ—¥å¿—æ–‡ä»¶
tail -f kk_stock_backend/logs/daemon_20240804.log

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
grep -i error kk_stock_backend/logs/*.log
```

## ğŸ¯ æ€»ç»“

`start_backend.sh` è„šæœ¬ä¸ºKKè‚¡ç¥¨é‡åŒ–åˆ†æç³»ç»Ÿåç«¯æä¾›äº†å®Œæ•´çš„æœåŠ¡ç®¡ç†è§£å†³æ–¹æ¡ˆã€‚é€šè¿‡å…¨å±€è·¯å¾„é…ç½®ã€æ™ºèƒ½ç¯å¢ƒç®¡ç†å’Œçµæ´»çš„éƒ¨ç½²é€‰é¡¹ï¼Œå¤§å¤§ç®€åŒ–äº†åç«¯æœåŠ¡çš„å¼€å‘ã€æµ‹è¯•å’Œç”Ÿäº§éƒ¨ç½²æµç¨‹ã€‚æ— è®ºæ˜¯å•æœºå¼€å‘è¿˜æ˜¯é›†ç¾¤éƒ¨ç½²ï¼Œéƒ½èƒ½æä¾›ç¨³å®šå¯é çš„æœåŠ¡ç®¡ç†èƒ½åŠ›ã€‚

### ğŸŒŸ æ ¸å¿ƒä¼˜åŠ¿
- ğŸŒ **å…¨å±€è·¯å¾„é…ç½®** - çµæ´»é€‚é…ä¸åŒéƒ¨ç½²ç¯å¢ƒ
- ğŸ”§ **æ™ºèƒ½ç¯å¢ƒç®¡ç†** - è‡ªåŠ¨åŒ–Condaç¯å¢ƒå’Œä¾èµ–ç®¡ç†  
- ğŸš€ **ç”Ÿäº§çº§éƒ¨ç½²** - æ”¯æŒå¤šWorkeré«˜å¹¶å‘æ¨¡å¼
- ğŸ“Š **å®Œå–„ç›‘æ§** - è¯¦ç»†çš„æ—¥å¿—è®°å½•å’ŒçŠ¶æ€ç›‘æ§
- ğŸ› ï¸ **æ˜“äºç»´æŠ¤** - ç®€å•çš„å‘½ä»¤è¡Œæ¥å£å’Œæ•…éšœæ’æŸ¥

---

**Happy Coding! ğŸš€**