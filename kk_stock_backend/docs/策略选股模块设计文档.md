# 策略选股模块设计文档

## 📋 项目概述

### 目标
基于现有的量化分析系统，新增策略选股模块，提供技术面、基本面和特色选股功能，帮助用户发现投资机会。

### 核心特色
- **多维度选股**：技术面 + 基本面 + 特色数据（连板天梯、游资交易等）
- **实时计算**：基于最新数据的动态选股
- **策略回测**：历史数据验证策略有效性
- **个性化定制**：支持自定义策略参数和权重

## 🏗️ 系统架构

### 数据层
```
现有数据集合：
├── 基础数据
│   ├── stock_basic (股票基本信息)
│   ├── trading_calendar (交易日历)
│   └── stock_company (公司信息)
├── 行情数据
│   ├── stock_daily (日线数据)
│   ├── stock_weekly (周线数据)
│   └── stock_monthly (月线数据)
├── 财务数据
│   ├── stock_fina_indicator (财务指标)
│   ├── stock_income (利润表)
│   ├── stock_balancesheet (资产负债表)
│   └── stock_cashflow (现金流量表)
├── 技术数据
│   └── stock_factor_pro (技术面因子)
└── 特色数据
    ├── limit_step (连板天梯)
    ├── top_list (龙虎榜)
    ├── top_inst (机构交易)
    └── money_flow_* (资金流向)
```

### 新增数据集合
```
策略选股相关：
├── stock_technical_indicators (预计算技术指标)
├── stock_fundamental_scores (基本面评分)
├── stock_strategy_results (策略选股结果)
└── user_strategies (用户自定义策略)
```

## 🎯 功能模块设计

### 1. 技术面选股模块

#### 核心技术指标
- **MACD指标**：趋势跟踪，识别买卖信号
- **RSI指标**：相对强弱，判断超买超卖
- **KDJ指标**：随机指标，短期买卖时机
- **布林带**：价格通道，突破信号识别
- **均线系统**：MA5/10/20/60多周期分析
- **成交量分析**：量价配合，资金流向判断

#### 选股策略
```python
技术面选股条件示例：
1. 金叉策略：MACD金叉 + RSI < 70 + 成交量放大
2. 突破策略：价格突破布林带上轨 + 成交量确认
3. 超跌反弹：RSI < 30 + KDJ低位金叉
4. 强势股：价格站上所有均线 + 成交量持续放大
```

### 2. 基本面选股模块

#### 财务指标体系
- **成长性指标**：营收增长率、净利润增长率、ROE增长
- **盈利能力**：ROE、ROA、毛利率、净利率
- **估值指标**：PE、PB、PEG、EV/EBITDA
- **财务质量**：资产负债率、流动比率、现金流
- **分红能力**：股息率、分红比例、分红稳定性

#### 评分模型
```python
基本面评分算法：
1. 成长性评分 (0-100分)
   - 营收增长率权重：30%
   - 净利润增长率权重：40%
   - ROE增长权重：30%

2. 盈利能力评分 (0-100分)
   - ROE权重：40%
   - 毛利率权重：30%
   - 净利率权重：30%

3. 估值水平评分 (0-100分)
   - PE相对位置：40%
   - PB相对位置：30%
   - PEG合理性：30%

综合评分 = 成长性×0.4 + 盈利能力×0.3 + 估值水平×0.3
```

### 3. 特色选股模块

#### 连板天梯分析
- **连板强度**：基于limit_step数据计算板块热度
- **进阶成功率**：统计各连板阶段的成功概率
- **板块轮动**：识别热点板块切换信号

#### 游资追踪
- **游资活跃度**：基于top_list数据分析游资偏好
- **席位分析**：识别知名游资操作模式
- **跟庄策略**：跟踪强势游资的选股逻辑

#### 资金流向分析
- **主力资金**：大单净流入分析
- **散户情绪**：小单流向判断市场情绪
- **机构动向**：基于top_inst数据分析机构偏好

## 🔧 技术实现方案

### 后端API设计

#### 路由结构
```python
# api/routers/strategy.py

@router.get("/technical-screening")
async def technical_screening(
    indicators: List[str],  # 技术指标列表
    conditions: Dict,       # 筛选条件
    limit: int = 100       # 返回数量限制
):
    """技术面选股接口"""

@router.get("/fundamental-screening")
async def fundamental_screening(
    growth_min: float,      # 成长性最低分
    profit_min: float,      # 盈利能力最低分
    valuation_max: float,   # 估值水平最高分
    industry: Optional[str] # 行业过滤
):
    """基本面选股接口"""

@router.get("/special-screening")
async def special_screening(
    limit_days: int,        # 连板天数
    money_flow_strength: float,  # 资金流向强度
    dragon_tiger: bool      # 是否包含龙虎榜
):
    """特色选股接口"""

@router.get("/combined-screening")
async def combined_screening(
    technical_weight: float,    # 技术面权重
    fundamental_weight: float,  # 基本面权重
    special_weight: float      # 特色权重
):
    """综合选股接口"""

@router.post("/strategy/save")
async def save_strategy(
    strategy: UserStrategy  # 用户策略配置
):
    """保存用户策略"""

@router.get("/strategy/backtest")
async def backtest_strategy(
    strategy_id: str,       # 策略ID
    start_date: str,        # 回测开始日期
    end_date: str          # 回测结束日期
):
    """策略回测接口"""
```

#### 核心算法实现

##### 技术指标计算
```python
class TechnicalIndicators:
    @staticmethod
    def calculate_macd(prices: List[float], fast=12, slow=26, signal=9):
        """计算MACD指标"""
        
    @staticmethod
    def calculate_rsi(prices: List[float], period=14):
        """计算RSI指标"""
        
    @staticmethod
    def calculate_kdj(high: List[float], low: List[float], 
                     close: List[float], period=9):
        """计算KDJ指标"""
        
    @staticmethod
    def calculate_bollinger_bands(prices: List[float], period=20, std=2):
        """计算布林带"""
```

##### 基本面评分
```python
class FundamentalScoring:
    @staticmethod
    def calculate_growth_score(financial_data: Dict) -> float:
        """计算成长性评分"""
        
    @staticmethod
    def calculate_profitability_score(financial_data: Dict) -> float:
        """计算盈利能力评分"""
        
    @staticmethod
    def calculate_valuation_score(financial_data: Dict, 
                                market_data: Dict) -> float:
        """计算估值水平评分"""
```

### 前端组件设计

#### 组件结构
```
src/components/strategy/
├── StrategyScreeningPanel.vue     # 主选股面板
├── TechnicalScreening.vue         # 技术面选股
├── FundamentalScreening.vue       # 基本面选股
├── SpecialScreening.vue           # 特色选股
├── CombinedScreening.vue          # 综合选股
├── ScreeningResults.vue           # 结果展示
├── StrategyBacktest.vue           # 策略回测
├── StrategyTemplates.vue          # 策略模板
└── UserStrategies.vue             # 用户策略管理
```

#### 主要功能
- **参数配置**：直观的滑块和选择器
- **实时预览**：参数调整时实时显示筛选数量
- **结果展示**：表格 + 图表的多维度展示
- **策略保存**：支持自定义策略保存和分享
- **回测分析**：可视化的回测结果展示

## 📊 数据库设计

### 新增集合结构

#### stock_technical_indicators
```javascript
{
  ts_code: "000001.SZ",
  trade_date: "20240115",
  macd: {
    dif: 0.15,
    dea: 0.12,
    macd: 0.06
  },
  rsi: {
    rsi_6: 65.2,
    rsi_14: 58.7,
    rsi_24: 52.3
  },
  kdj: {
    k: 75.6,
    d: 68.9,
    j: 89.0
  },
  bollinger: {
    upper: 12.50,
    middle: 11.80,
    lower: 11.10
  },
  ma: {
    ma5: 11.85,
    ma10: 11.75,
    ma20: 11.60,
    ma60: 11.20
  },
  volume_ma: {
    vol_ma5: 1500000,
    vol_ma10: 1200000
  }
}
```

#### stock_fundamental_scores
```javascript
{
  ts_code: "000001.SZ",
  report_date: "20231231",
  scores: {
    growth: 85.5,        # 成长性评分
    profitability: 78.2, # 盈利能力评分
    valuation: 65.8,     # 估值水平评分
    quality: 82.1,       # 财务质量评分
    comprehensive: 77.9   # 综合评分
  },
  indicators: {
    roe: 15.2,
    roa: 8.5,
    pe: 18.5,
    pb: 1.8,
    revenue_growth: 12.5,
    profit_growth: 18.3
  },
  industry_rank: 15,     # 行业排名
  industry_total: 120    # 行业总数
}
```

### 索引优化
```javascript
// 技术指标集合索引
db.stock_technical_indicators.createIndex({"ts_code": 1, "trade_date": -1})
db.stock_technical_indicators.createIndex({"trade_date": -1})

// 基本面评分集合索引
db.stock_fundamental_scores.createIndex({"ts_code": 1, "report_date": -1})
db.stock_fundamental_scores.createIndex({"scores.comprehensive": -1})
db.stock_fundamental_scores.createIndex({"industry_rank": 1})

// 策略结果集合索引
db.stock_strategy_results.createIndex({"strategy_id": 1, "created_at": -1})
db.stock_strategy_results.createIndex({"created_at": -1})
```

## 🚀 实施计划

### 第一阶段：核心功能开发（2-3周）

#### Week 1: 后端基础
- [ ] 创建strategy.py路由文件
- [ ] 实现技术指标计算算法
- [ ] 开发技术面选股接口
- [ ] 实现基本面评分模型
- [ ] 开发基本面选股接口

#### Week 2: 特色功能
- [ ] 实现连板天梯分析算法
- [ ] 开发游资追踪功能
- [ ] 实现资金流向分析
- [ ] 开发特色选股接口
- [ ] 实现综合选股算法

#### Week 3: 前端界面
- [ ] 创建主选股面板组件
- [ ] 实现技术面选股界面
- [ ] 实现基本面选股界面
- [ ] 实现特色选股界面
- [ ] 开发结果展示组件

### 第二阶段：优化和扩展（2周）

#### Week 4: 性能优化
- [ ] 数据库索引优化
- [ ] Redis缓存实现
- [ ] 预计算任务开发
- [ ] API性能优化

#### Week 5: 用户体验
- [ ] 策略模板开发
- [ ] 用户策略保存功能
- [ ] 策略回测功能
- [ ] 可视化优化

### 第三阶段：测试和部署（1周）

#### Week 6: 测试部署
- [ ] 单元测试编写
- [ ] 集成测试
- [ ] 性能测试
- [ ] 用户体验测试
- [ ] 文档完善

## 📈 预期效果

### 功能特色
1. **多维度融合**：技术+基本面+特色数据的立体选股
2. **实时响应**：基于最新数据的动态筛选
3. **个性化定制**：支持用户自定义策略参数
4. **历史验证**：策略回测验证有效性
5. **可视化展示**：直观的图表和评分展示

### 技术优势
1. **高性能**：预计算+缓存的高效架构
2. **可扩展**：模块化设计便于功能扩展
3. **易维护**：清晰的代码结构和文档
4. **用户友好**：直观的界面和交互设计

## 🔍 风险控制

### 技术风险
- **数据质量**：建立数据验证和清洗机制
- **计算性能**：合理的缓存和预计算策略
- **系统稳定性**：完善的错误处理和监控

### 业务风险
- **策略有效性**：通过历史回测验证
- **市场适应性**：定期更新和优化算法
- **用户体验**：持续收集反馈并改进

---

**文档版本**: v1.0  
**创建日期**: 2024年1月  
**最后更新**: 2024年1月  
**负责人**: 量化分析团队