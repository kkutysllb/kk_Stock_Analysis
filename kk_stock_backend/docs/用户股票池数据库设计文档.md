# 用户股票池数据库设计文档

## 📋 概述

基于现有用户认证系统，设计用户个人股票池功能，实现策略选股结果的个性化存储和管理。

## 🏗️ 数据库结构设计

### 1. 现有用户表结构 (users)

```javascript
{
  "_id": ObjectId,
  "user_id": "unique_user_id",
  "login_type": "wechat|phone",
  "phone": "手机号",
  "wechat_openid": "微信openid",
  "roles": ["user", "analyst", "operator", "admin"],
  "status": 1,  // 1-正常 0-禁用
  "create_time": ISODate,
  "last_login": ISODate,
  "login_count": 0,
  "module_call_count": 0,
  "module_call_detail": {},
  "recharge_amount": 9999999999,
  "recharge_order_id": "UNLIMITED",
  "extra_info": {}
}
```

### 2. 新增：用户股票池表 (user_stock_pools)

```javascript
{
  "_id": ObjectId,
  "user_id": "用户ID",
  "pool_name": "股票池名称",
  "pool_type": "策略选股类型",  // "technical", "fundamental", "special", "combined", "custom"
  "description": "股票池描述",
  "stocks": [
    {
      "ts_code": "000001.SZ",
      "stock_name": "平安银行",
      "add_date": ISODate,
      "add_price": 12.50,
      "current_price": 13.20,
      "score": 85.5,  // 综合评分
      "scores": {
        "technical": 78.2,
        "fundamental": 82.1,
        "special": 90.3
      },
      "tags": ["连板股", "游资关注", "基本面优秀"],
      "notes": "用户备注",
      "status": "active"  // "active", "sold", "watching"
    }
  ],
  "strategy_config": {
    "technical": {
      "macd_signal": "golden_cross",
      "rsi_range": [30, 70],
      "ma_trend": "bullish"
    },
    "fundamental": {
      "roe_min": 10,
      "pe_max": 30,
      "revenue_growth_min": 15
    },
    "special": {
      "limit_days": 3,
      "dragon_tiger": true
    }
  },
  "performance": {
    "total_return": 8.5,  // 总收益率%
    "win_rate": 65.2,    // 胜率%
    "max_drawdown": -12.3, // 最大回撤%
    "sharpe_ratio": 1.25   // 夏普比率
  },
  "create_time": ISODate,
  "update_time": ISODate,
  "is_default": false,  // 是否为默认股票池
  "is_public": false,   // 是否公开分享
  "share_code": "ABC123" // 分享码
}
```

### 3. 新增：股票池操作记录表 (user_pool_operations)

```javascript
{
  "_id": ObjectId,
  "user_id": "用户ID",
  "pool_id": ObjectId,  // 股票池ID
  "operation_type": "操作类型",  // "add", "remove", "update", "buy", "sell"
  "ts_code": "000001.SZ",
  "operation_data": {
    "price": 12.50,
    "quantity": 1000,
    "reason": "操作原因",
    "notes": "备注"
  },
  "operation_time": ISODate,
  "ip_address": "操作IP",
  "user_agent": "用户代理"
}
```

### 4. 新增：策略选股结果表 (strategy_screening_results)

```javascript
{
  "_id": ObjectId,
  "user_id": "用户ID",
  "strategy_name": "策略名称",
  "strategy_type": "technical|fundamental|special|combined",
  "screening_date": ISODate,
  "conditions": {
    "technical": {...},
    "fundamental": {...},
    "special": {...}
  },
  "results": [
    {
      "ts_code": "000001.SZ",
      "stock_name": "平安银行",
      "score": 85.5,
      "scores": {
        "technical": 78.2,
        "fundamental": 82.1,
        "special": 90.3
      },
      "indicators": {
        "pe": 8.5,
        "pb": 0.8,
        "roe": 12.5,
        "rsi": 45.2,
        "macd": 0.15
      },
      "rank": 1
    }
  ],
  "total_count": 50,
  "execution_time": 2.5,  // 执行时间(秒)
  "is_saved_to_pool": false,
  "saved_pool_id": null
}
```

### 5. 新增：用户策略模板表 (user_strategy_templates)

```javascript
{
  "_id": ObjectId,
  "user_id": "用户ID",
  "template_name": "我的价值投资策略",
  "template_type": "fundamental",
  "description": "专注低估值高成长股票",
  "conditions": {
    "fundamental": {
      "roe_min": 15,
      "pe_max": 20,
      "pb_max": 2,
      "revenue_growth_min": 20
    },
    "technical": {
      "rsi_range": [30, 70],
      "ma_trend": "bullish"
    }
  },
  "weights": {
    "technical": 0.3,
    "fundamental": 0.7,
    "special": 0.0
  },
  "usage_count": 15,
  "success_rate": 68.5,
  "avg_return": 12.3,
  "create_time": ISODate,
  "update_time": ISODate,
  "is_public": false,
  "tags": ["价值投资", "长线持有"]
}
```

## 🔧 索引设计

### user_stock_pools 索引
```javascript
// 用户查询索引
db.user_stock_pools.createIndex({"user_id": 1, "create_time": -1})

// 股票池类型索引
db.user_stock_pools.createIndex({"user_id": 1, "pool_type": 1})

// 默认股票池索引
db.user_stock_pools.createIndex({"user_id": 1, "is_default": 1})

// 公开分享索引
db.user_stock_pools.createIndex({"is_public": 1, "create_time": -1})

// 分享码索引
db.user_stock_pools.createIndex({"share_code": 1}, {unique: true, sparse: true})

// 股票代码索引（用于查找包含特定股票的股票池）
db.user_stock_pools.createIndex({"stocks.ts_code": 1})
```

### user_pool_operations 索引
```javascript
// 用户操作记录索引
db.user_pool_operations.createIndex({"user_id": 1, "operation_time": -1})

// 股票池操作记录索引
db.user_pool_operations.createIndex({"pool_id": 1, "operation_time": -1})

// 股票操作记录索引
db.user_pool_operations.createIndex({"ts_code": 1, "operation_time": -1})
```

### strategy_screening_results 索引
```javascript
// 用户选股结果索引
db.strategy_screening_results.createIndex({"user_id": 1, "screening_date": -1})

// 策略类型索引
db.strategy_screening_results.createIndex({"strategy_type": 1, "screening_date": -1})

// 结果股票索引
db.strategy_screening_results.createIndex({"results.ts_code": 1})
```

### user_strategy_templates 索引
```javascript
// 用户模板索引
db.user_strategy_templates.createIndex({"user_id": 1, "create_time": -1})

// 公开模板索引
db.user_strategy_templates.createIndex({"is_public": 1, "usage_count": -1})

// 模板类型索引
db.user_strategy_templates.createIndex({"template_type": 1, "success_rate": -1})
```

## 🎯 核心功能设计

### 1. 股票池管理功能

#### 创建股票池
- 支持从选股结果直接创建
- 支持手动创建空股票池
- 自动生成默认股票池

#### 股票池操作
- 添加/删除股票
- 批量导入股票
- 股票池合并/拆分
- 股票池复制/分享

#### 股票池分析
- 实时收益统计
- 风险指标计算
- 行业分布分析
- 持仓建议

### 2. 策略选股集成

#### 选股结果保存
```python
# 选股完成后自动保存结果
async def save_screening_result(user_id: str, strategy_config: dict, results: list):
    result_doc = {
        "user_id": user_id,
        "strategy_name": strategy_config.get("name", "未命名策略"),
        "strategy_type": strategy_config.get("type", "combined"),
        "screening_date": datetime.utcnow(),
        "conditions": strategy_config.get("conditions", {}),
        "results": results,
        "total_count": len(results),
        "execution_time": strategy_config.get("execution_time", 0),
        "is_saved_to_pool": False
    }
    return await db.strategy_screening_results.insert_one(result_doc)
```

#### 一键加入股票池
```python
# 将选股结果添加到指定股票池
async def add_to_stock_pool(user_id: str, pool_id: str, stocks: list):
    for stock in stocks:
        stock_doc = {
            "ts_code": stock["ts_code"],
            "stock_name": stock["stock_name"],
            "add_date": datetime.utcnow(),
            "add_price": stock.get("current_price", 0),
            "score": stock.get("score", 0),
            "scores": stock.get("scores", {}),
            "tags": stock.get("tags", []),
            "status": "active"
        }
    
    await db.user_stock_pools.update_one(
        {"_id": ObjectId(pool_id), "user_id": user_id},
        {
            "$push": {"stocks": {"$each": stocks}},
            "$set": {"update_time": datetime.utcnow()}
        }
    )
```

### 3. 策略模板系统

#### 模板保存
- 将成功的选股策略保存为模板
- 支持模板参数调整
- 模板效果跟踪

#### 模板分享
- 公开优秀策略模板
- 模板使用统计
- 社区评分系统

## 📊 数据流程设计

### 1. 用户选股流程
```
用户登录 → 选择策略类型 → 设置筛选条件 → 执行选股 → 查看结果 → 保存到股票池
```

### 2. 股票池管理流程
```
创建股票池 → 添加股票 → 实时监控 → 调整持仓 → 记录操作 → 分析收益
```

### 3. 策略优化流程
```
历史回测 → 效果分析 → 参数调优 → 模板保存 → 实盘验证 → 策略分享
```

## 🔒 权限控制

### 用户权限等级
- **普通用户**: 基础选股功能，最多3个股票池，每池最多50只股票
- **分析师**: 高级选股功能，最多10个股票池，每池最多200只股票
- **操作员**: 全部选股功能，无限制股票池
- **管理员**: 全部功能 + 用户管理 + 数据管理

### 功能权限矩阵
| 功能 | 普通用户 | 分析师 | 操作员 | 管理员 |
|------|---------|--------|--------|--------|
| 技术面选股 | ✓ | ✓ | ✓ | ✓ |
| 基本面选股 | ✓ | ✓ | ✓ | ✓ |
| 特色选股 | ✗ | ✓ | ✓ | ✓ |
| 综合选股 | ✗ | ✓ | ✓ | ✓ |
| 策略回测 | ✗ | ✓ | ✓ | ✓ |
| 模板分享 | ✗ | ✓ | ✓ | ✓ |
| 数据导出 | ✗ | ✓ | ✓ | ✓ |

## 🚀 实施计划

### 第一阶段：数据库设计（1周）
- [ ] 创建数据库集合和索引
- [ ] 编写数据库初始化脚本
- [ ] 测试数据库性能

### 第二阶段：后端API开发（2周）
- [ ] 股票池管理API
- [ ] 选股结果保存API
- [ ] 策略模板API
- [ ] 权限控制集成

### 第三阶段：前端界面开发（2周）
- [ ] 股票池管理界面
- [ ] 选股结果展示界面
- [ ] 策略模板管理界面
- [ ] 用户权限界面

### 第四阶段：测试和优化（1周）
- [ ] 功能测试
- [ ] 性能测试
- [ ] 用户体验优化
- [ ] 文档完善

---

**文档版本**: v1.0  
**创建日期**: 2024年1月  
**最后更新**: 2024年1月  
**负责人**: 量化分析团队