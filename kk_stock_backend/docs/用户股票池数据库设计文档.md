# ç”¨æˆ·è‚¡ç¥¨æ± æ•°æ®åº“è®¾è®¡æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

åŸºäºç°æœ‰ç”¨æˆ·è®¤è¯ç³»ç»Ÿï¼Œè®¾è®¡ç”¨æˆ·ä¸ªäººè‚¡ç¥¨æ± åŠŸèƒ½ï¼Œå®ç°ç­–ç•¥é€‰è‚¡ç»“æœçš„ä¸ªæ€§åŒ–å­˜å‚¨å’Œç®¡ç†ã€‚

## ğŸ—ï¸ æ•°æ®åº“ç»“æ„è®¾è®¡

### 1. ç°æœ‰ç”¨æˆ·è¡¨ç»“æ„ (users)

```javascript
{
  "_id": ObjectId,
  "user_id": "unique_user_id",
  "login_type": "wechat|phone",
  "phone": "æ‰‹æœºå·",
  "wechat_openid": "å¾®ä¿¡openid",
  "roles": ["user", "analyst", "operator", "admin"],
  "status": 1,  // 1-æ­£å¸¸ 0-ç¦ç”¨
  "create_time": ISODate,
  "last_login": ISODate,
  "login_count": 0,
  "module_call_count": 0,
  "module_call_detail": {},
  "recharge_amount": 9999999999,
  "recharge_order_id": "UNLIMITED",
  "extra_info": {}
}
```

### 2. æ–°å¢ï¼šç”¨æˆ·è‚¡ç¥¨æ± è¡¨ (user_stock_pools)

```javascript
{
  "_id": ObjectId,
  "user_id": "ç”¨æˆ·ID",
  "pool_name": "è‚¡ç¥¨æ± åç§°",
  "pool_type": "ç­–ç•¥é€‰è‚¡ç±»å‹",  // "technical", "fundamental", "special", "combined", "custom"
  "description": "è‚¡ç¥¨æ± æè¿°",
  "stocks": [
    {
      "ts_code": "000001.SZ",
      "stock_name": "å¹³å®‰é“¶è¡Œ",
      "add_date": ISODate,
      "add_price": 12.50,
      "current_price": 13.20,
      "score": 85.5,  // ç»¼åˆè¯„åˆ†
      "scores": {
        "technical": 78.2,
        "fundamental": 82.1,
        "special": 90.3
      },
      "tags": ["è¿æ¿è‚¡", "æ¸¸èµ„å…³æ³¨", "åŸºæœ¬é¢ä¼˜ç§€"],
      "notes": "ç”¨æˆ·å¤‡æ³¨",
      "status": "active"  // "active", "sold", "watching"
    }
  ],
  "strategy_config": {
    "technical": {
      "macd_signal": "golden_cross",
      "rsi_range": [30, 70],
      "ma_trend": "bullish"
    },
    "fundamental": {
      "roe_min": 10,
      "pe_max": 30,
      "revenue_growth_min": 15
    },
    "special": {
      "limit_days": 3,
      "dragon_tiger": true
    }
  },
  "performance": {
    "total_return": 8.5,  // æ€»æ”¶ç›Šç‡%
    "win_rate": 65.2,    // èƒœç‡%
    "max_drawdown": -12.3, // æœ€å¤§å›æ’¤%
    "sharpe_ratio": 1.25   // å¤æ™®æ¯”ç‡
  },
  "create_time": ISODate,
  "update_time": ISODate,
  "is_default": false,  // æ˜¯å¦ä¸ºé»˜è®¤è‚¡ç¥¨æ± 
  "is_public": false,   // æ˜¯å¦å…¬å¼€åˆ†äº«
  "share_code": "ABC123" // åˆ†äº«ç 
}
```

### 3. æ–°å¢ï¼šè‚¡ç¥¨æ± æ“ä½œè®°å½•è¡¨ (user_pool_operations)

```javascript
{
  "_id": ObjectId,
  "user_id": "ç”¨æˆ·ID",
  "pool_id": ObjectId,  // è‚¡ç¥¨æ± ID
  "operation_type": "æ“ä½œç±»å‹",  // "add", "remove", "update", "buy", "sell"
  "ts_code": "000001.SZ",
  "operation_data": {
    "price": 12.50,
    "quantity": 1000,
    "reason": "æ“ä½œåŸå› ",
    "notes": "å¤‡æ³¨"
  },
  "operation_time": ISODate,
  "ip_address": "æ“ä½œIP",
  "user_agent": "ç”¨æˆ·ä»£ç†"
}
```

### 4. æ–°å¢ï¼šç­–ç•¥é€‰è‚¡ç»“æœè¡¨ (strategy_screening_results)

```javascript
{
  "_id": ObjectId,
  "user_id": "ç”¨æˆ·ID",
  "strategy_name": "ç­–ç•¥åç§°",
  "strategy_type": "technical|fundamental|special|combined",
  "screening_date": ISODate,
  "conditions": {
    "technical": {...},
    "fundamental": {...},
    "special": {...}
  },
  "results": [
    {
      "ts_code": "000001.SZ",
      "stock_name": "å¹³å®‰é“¶è¡Œ",
      "score": 85.5,
      "scores": {
        "technical": 78.2,
        "fundamental": 82.1,
        "special": 90.3
      },
      "indicators": {
        "pe": 8.5,
        "pb": 0.8,
        "roe": 12.5,
        "rsi": 45.2,
        "macd": 0.15
      },
      "rank": 1
    }
  ],
  "total_count": 50,
  "execution_time": 2.5,  // æ‰§è¡Œæ—¶é—´(ç§’)
  "is_saved_to_pool": false,
  "saved_pool_id": null
}
```

### 5. æ–°å¢ï¼šç”¨æˆ·ç­–ç•¥æ¨¡æ¿è¡¨ (user_strategy_templates)

```javascript
{
  "_id": ObjectId,
  "user_id": "ç”¨æˆ·ID",
  "template_name": "æˆ‘çš„ä»·å€¼æŠ•èµ„ç­–ç•¥",
  "template_type": "fundamental",
  "description": "ä¸“æ³¨ä½ä¼°å€¼é«˜æˆé•¿è‚¡ç¥¨",
  "conditions": {
    "fundamental": {
      "roe_min": 15,
      "pe_max": 20,
      "pb_max": 2,
      "revenue_growth_min": 20
    },
    "technical": {
      "rsi_range": [30, 70],
      "ma_trend": "bullish"
    }
  },
  "weights": {
    "technical": 0.3,
    "fundamental": 0.7,
    "special": 0.0
  },
  "usage_count": 15,
  "success_rate": 68.5,
  "avg_return": 12.3,
  "create_time": ISODate,
  "update_time": ISODate,
  "is_public": false,
  "tags": ["ä»·å€¼æŠ•èµ„", "é•¿çº¿æŒæœ‰"]
}
```

## ğŸ”§ ç´¢å¼•è®¾è®¡

### user_stock_pools ç´¢å¼•
```javascript
// ç”¨æˆ·æŸ¥è¯¢ç´¢å¼•
db.user_stock_pools.createIndex({"user_id": 1, "create_time": -1})

// è‚¡ç¥¨æ± ç±»å‹ç´¢å¼•
db.user_stock_pools.createIndex({"user_id": 1, "pool_type": 1})

// é»˜è®¤è‚¡ç¥¨æ± ç´¢å¼•
db.user_stock_pools.createIndex({"user_id": 1, "is_default": 1})

// å…¬å¼€åˆ†äº«ç´¢å¼•
db.user_stock_pools.createIndex({"is_public": 1, "create_time": -1})

// åˆ†äº«ç ç´¢å¼•
db.user_stock_pools.createIndex({"share_code": 1}, {unique: true, sparse: true})

// è‚¡ç¥¨ä»£ç ç´¢å¼•ï¼ˆç”¨äºæŸ¥æ‰¾åŒ…å«ç‰¹å®šè‚¡ç¥¨çš„è‚¡ç¥¨æ± ï¼‰
db.user_stock_pools.createIndex({"stocks.ts_code": 1})
```

### user_pool_operations ç´¢å¼•
```javascript
// ç”¨æˆ·æ“ä½œè®°å½•ç´¢å¼•
db.user_pool_operations.createIndex({"user_id": 1, "operation_time": -1})

// è‚¡ç¥¨æ± æ“ä½œè®°å½•ç´¢å¼•
db.user_pool_operations.createIndex({"pool_id": 1, "operation_time": -1})

// è‚¡ç¥¨æ“ä½œè®°å½•ç´¢å¼•
db.user_pool_operations.createIndex({"ts_code": 1, "operation_time": -1})
```

### strategy_screening_results ç´¢å¼•
```javascript
// ç”¨æˆ·é€‰è‚¡ç»“æœç´¢å¼•
db.strategy_screening_results.createIndex({"user_id": 1, "screening_date": -1})

// ç­–ç•¥ç±»å‹ç´¢å¼•
db.strategy_screening_results.createIndex({"strategy_type": 1, "screening_date": -1})

// ç»“æœè‚¡ç¥¨ç´¢å¼•
db.strategy_screening_results.createIndex({"results.ts_code": 1})
```

### user_strategy_templates ç´¢å¼•
```javascript
// ç”¨æˆ·æ¨¡æ¿ç´¢å¼•
db.user_strategy_templates.createIndex({"user_id": 1, "create_time": -1})

// å…¬å¼€æ¨¡æ¿ç´¢å¼•
db.user_strategy_templates.createIndex({"is_public": 1, "usage_count": -1})

// æ¨¡æ¿ç±»å‹ç´¢å¼•
db.user_strategy_templates.createIndex({"template_type": 1, "success_rate": -1})
```

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½è®¾è®¡

### 1. è‚¡ç¥¨æ± ç®¡ç†åŠŸèƒ½

#### åˆ›å»ºè‚¡ç¥¨æ± 
- æ”¯æŒä»é€‰è‚¡ç»“æœç›´æ¥åˆ›å»º
- æ”¯æŒæ‰‹åŠ¨åˆ›å»ºç©ºè‚¡ç¥¨æ± 
- è‡ªåŠ¨ç”Ÿæˆé»˜è®¤è‚¡ç¥¨æ± 

#### è‚¡ç¥¨æ± æ“ä½œ
- æ·»åŠ /åˆ é™¤è‚¡ç¥¨
- æ‰¹é‡å¯¼å…¥è‚¡ç¥¨
- è‚¡ç¥¨æ± åˆå¹¶/æ‹†åˆ†
- è‚¡ç¥¨æ± å¤åˆ¶/åˆ†äº«

#### è‚¡ç¥¨æ± åˆ†æ
- å®æ—¶æ”¶ç›Šç»Ÿè®¡
- é£é™©æŒ‡æ ‡è®¡ç®—
- è¡Œä¸šåˆ†å¸ƒåˆ†æ
- æŒä»“å»ºè®®

### 2. ç­–ç•¥é€‰è‚¡é›†æˆ

#### é€‰è‚¡ç»“æœä¿å­˜
```python
# é€‰è‚¡å®Œæˆåè‡ªåŠ¨ä¿å­˜ç»“æœ
async def save_screening_result(user_id: str, strategy_config: dict, results: list):
    result_doc = {
        "user_id": user_id,
        "strategy_name": strategy_config.get("name", "æœªå‘½åç­–ç•¥"),
        "strategy_type": strategy_config.get("type", "combined"),
        "screening_date": datetime.utcnow(),
        "conditions": strategy_config.get("conditions", {}),
        "results": results,
        "total_count": len(results),
        "execution_time": strategy_config.get("execution_time", 0),
        "is_saved_to_pool": False
    }
    return await db.strategy_screening_results.insert_one(result_doc)
```

#### ä¸€é”®åŠ å…¥è‚¡ç¥¨æ± 
```python
# å°†é€‰è‚¡ç»“æœæ·»åŠ åˆ°æŒ‡å®šè‚¡ç¥¨æ± 
async def add_to_stock_pool(user_id: str, pool_id: str, stocks: list):
    for stock in stocks:
        stock_doc = {
            "ts_code": stock["ts_code"],
            "stock_name": stock["stock_name"],
            "add_date": datetime.utcnow(),
            "add_price": stock.get("current_price", 0),
            "score": stock.get("score", 0),
            "scores": stock.get("scores", {}),
            "tags": stock.get("tags", []),
            "status": "active"
        }
    
    await db.user_stock_pools.update_one(
        {"_id": ObjectId(pool_id), "user_id": user_id},
        {
            "$push": {"stocks": {"$each": stocks}},
            "$set": {"update_time": datetime.utcnow()}
        }
    )
```

### 3. ç­–ç•¥æ¨¡æ¿ç³»ç»Ÿ

#### æ¨¡æ¿ä¿å­˜
- å°†æˆåŠŸçš„é€‰è‚¡ç­–ç•¥ä¿å­˜ä¸ºæ¨¡æ¿
- æ”¯æŒæ¨¡æ¿å‚æ•°è°ƒæ•´
- æ¨¡æ¿æ•ˆæœè·Ÿè¸ª

#### æ¨¡æ¿åˆ†äº«
- å…¬å¼€ä¼˜ç§€ç­–ç•¥æ¨¡æ¿
- æ¨¡æ¿ä½¿ç”¨ç»Ÿè®¡
- ç¤¾åŒºè¯„åˆ†ç³»ç»Ÿ

## ğŸ“Š æ•°æ®æµç¨‹è®¾è®¡

### 1. ç”¨æˆ·é€‰è‚¡æµç¨‹
```
ç”¨æˆ·ç™»å½• â†’ é€‰æ‹©ç­–ç•¥ç±»å‹ â†’ è®¾ç½®ç­›é€‰æ¡ä»¶ â†’ æ‰§è¡Œé€‰è‚¡ â†’ æŸ¥çœ‹ç»“æœ â†’ ä¿å­˜åˆ°è‚¡ç¥¨æ± 
```

### 2. è‚¡ç¥¨æ± ç®¡ç†æµç¨‹
```
åˆ›å»ºè‚¡ç¥¨æ±  â†’ æ·»åŠ è‚¡ç¥¨ â†’ å®æ—¶ç›‘æ§ â†’ è°ƒæ•´æŒä»“ â†’ è®°å½•æ“ä½œ â†’ åˆ†ææ”¶ç›Š
```

### 3. ç­–ç•¥ä¼˜åŒ–æµç¨‹
```
å†å²å›æµ‹ â†’ æ•ˆæœåˆ†æ â†’ å‚æ•°è°ƒä¼˜ â†’ æ¨¡æ¿ä¿å­˜ â†’ å®ç›˜éªŒè¯ â†’ ç­–ç•¥åˆ†äº«
```

## ğŸ”’ æƒé™æ§åˆ¶

### ç”¨æˆ·æƒé™ç­‰çº§
- **æ™®é€šç”¨æˆ·**: åŸºç¡€é€‰è‚¡åŠŸèƒ½ï¼Œæœ€å¤š3ä¸ªè‚¡ç¥¨æ± ï¼Œæ¯æ± æœ€å¤š50åªè‚¡ç¥¨
- **åˆ†æå¸ˆ**: é«˜çº§é€‰è‚¡åŠŸèƒ½ï¼Œæœ€å¤š10ä¸ªè‚¡ç¥¨æ± ï¼Œæ¯æ± æœ€å¤š200åªè‚¡ç¥¨
- **æ“ä½œå‘˜**: å…¨éƒ¨é€‰è‚¡åŠŸèƒ½ï¼Œæ— é™åˆ¶è‚¡ç¥¨æ± 
- **ç®¡ç†å‘˜**: å…¨éƒ¨åŠŸèƒ½ + ç”¨æˆ·ç®¡ç† + æ•°æ®ç®¡ç†

### åŠŸèƒ½æƒé™çŸ©é˜µ
| åŠŸèƒ½ | æ™®é€šç”¨æˆ· | åˆ†æå¸ˆ | æ“ä½œå‘˜ | ç®¡ç†å‘˜ |
|------|---------|--------|--------|--------|
| æŠ€æœ¯é¢é€‰è‚¡ | âœ“ | âœ“ | âœ“ | âœ“ |
| åŸºæœ¬é¢é€‰è‚¡ | âœ“ | âœ“ | âœ“ | âœ“ |
| ç‰¹è‰²é€‰è‚¡ | âœ— | âœ“ | âœ“ | âœ“ |
| ç»¼åˆé€‰è‚¡ | âœ— | âœ“ | âœ“ | âœ“ |
| ç­–ç•¥å›æµ‹ | âœ— | âœ“ | âœ“ | âœ“ |
| æ¨¡æ¿åˆ†äº« | âœ— | âœ“ | âœ“ | âœ“ |
| æ•°æ®å¯¼å‡º | âœ— | âœ“ | âœ“ | âœ“ |

## ğŸš€ å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šæ•°æ®åº“è®¾è®¡ï¼ˆ1å‘¨ï¼‰
- [ ] åˆ›å»ºæ•°æ®åº“é›†åˆå’Œç´¢å¼•
- [ ] ç¼–å†™æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
- [ ] æµ‹è¯•æ•°æ®åº“æ€§èƒ½

### ç¬¬äºŒé˜¶æ®µï¼šåç«¯APIå¼€å‘ï¼ˆ2å‘¨ï¼‰
- [ ] è‚¡ç¥¨æ± ç®¡ç†API
- [ ] é€‰è‚¡ç»“æœä¿å­˜API
- [ ] ç­–ç•¥æ¨¡æ¿API
- [ ] æƒé™æ§åˆ¶é›†æˆ

### ç¬¬ä¸‰é˜¶æ®µï¼šå‰ç«¯ç•Œé¢å¼€å‘ï¼ˆ2å‘¨ï¼‰
- [ ] è‚¡ç¥¨æ± ç®¡ç†ç•Œé¢
- [ ] é€‰è‚¡ç»“æœå±•ç¤ºç•Œé¢
- [ ] ç­–ç•¥æ¨¡æ¿ç®¡ç†ç•Œé¢
- [ ] ç”¨æˆ·æƒé™ç•Œé¢

### ç¬¬å››é˜¶æ®µï¼šæµ‹è¯•å’Œä¼˜åŒ–ï¼ˆ1å‘¨ï¼‰
- [ ] åŠŸèƒ½æµ‹è¯•
- [ ] æ€§èƒ½æµ‹è¯•
- [ ] ç”¨æˆ·ä½“éªŒä¼˜åŒ–
- [ ] æ–‡æ¡£å®Œå–„

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2024å¹´1æœˆ  
**æœ€åæ›´æ–°**: 2024å¹´1æœˆ  
**è´Ÿè´£äºº**: é‡åŒ–åˆ†æå›¢é˜Ÿ